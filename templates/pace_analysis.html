{% extends "base.html" %}

{% block title %}分析 - 県縦断駅伝{% endblock %}

{% block extra_css %}
<style>
    .analysis-header {
        background: var(--primary-gradient);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
    }
    .analysis-header h1 {
        font-size: 1.5rem;
        margin: 0;
    }

    /* タブナビゲーション */
    .analysis-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .analysis-tab {
        flex: 1;
        padding: 12px 16px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-muted);
        transition: all 0.2s;
        white-space: nowrap;
    }
    .analysis-tab:hover {
        background: var(--border-color);
    }
    .analysis-tab.active {
        background: var(--primary-gradient);
        border-color: transparent;
        color: white;
    }

    .filter-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .filter-card label {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 6px;
        display: block;
    }
    .filter-card select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        background-color: var(--input-bg);
        color: var(--text-color);
    }
    .avg-pace-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
        font-size: 1.1rem;
        text-align: center;
    }
    .results-table {
        background: var(--card-bg);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .results-table table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }
    .results-table th {
        background: var(--border-color);
        padding: 10px 8px;
        text-align: left;
        font-weight: 600;
        font-size: 0.75rem;
        color: var(--text-muted);
        white-space: nowrap;
    }
    .results-table td {
        padding: 10px 8px;
        border-bottom: 1px solid var(--border-color);
    }
    .results-table tr:last-child td {
        border-bottom: none;
    }

    /* チーム別背景色 */
    .team-南陽東置賜 { background-color: #FFB6C1; color: #333; }
    .team-北村山 { background-color: #FFD700; color: #333; }
    .team-天童東村山 { background-color: #90EE90; color: #333; }
    .team-新庄最上 { background-color: #ADD8E6; color: #333; }
    .team-山形 { background-color: #FFA07A; color: #333; }
    .team-酒田飽海 { background-color: #20B2AA; color: #333; }
    .team-鶴岡田川 { background-color: #778899; color: white; }
    .team-米沢 { background-color: #FFFFE0; color: #333; }
    .team-寒河江西村山 { background-color: #DB7093; color: white; }
    .team-長井西置賜 { background-color: #FF6347; color: white; }
    .team-上山 { background-color: #40E0D0; color: #333; }

    .fastest-time {
        background-color: #ffdd1a !important;
        font-weight: bold;
    }

    /* 気温背景色 */
    .temp-very-cold { background-color: #1E90FF; color: white; }
    .temp-cold { background-color: #00BFFF; color: white; }
    .temp-cool { background-color: #b3ecff; color: #333; }
    .temp-warm { background-color: #ffd4cc; color: #333; }
    .temp-hot { background-color: #ff9380; color: #333; }
    .temp-very-hot { background-color: #FF4500; color: white; }
    .temp-extreme { background-color: #B22222; color: white; }

    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
    }
    .loading .spinner-border {
        width: 2rem;
        height: 2rem;
    }
    .error-message {
        background: #fee2e2;
        color: #dc2626;
        padding: 16px;
        border-radius: 8px;
        text-align: center;
    }
    [data-theme="dark"] .error-message {
        background: rgba(220, 38, 38, 0.2);
    }

    /* レスポンシブテーブル */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }

    @media (max-width: 768px) {
        .results-table {
            font-size: 0.75rem;
        }
        .results-table th,
        .results-table td {
            padding: 8px 4px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analysis-header">
    <h1><i class="bi bi-graph-up me-2"></i>県縦断駅伝分析</h1>
</div>

<!-- タブナビゲーション -->
<div class="analysis-tabs">
    <div class="analysis-tab active" data-tab="pace">
        <i class="bi bi-speedometer2 me-1"></i>ペース分析
    </div>
    <div class="analysis-tab" data-tab="team">
        <i class="bi bi-people me-1"></i>チーム別区間
    </div>
    <div class="analysis-tab" data-tab="section">
        <i class="bi bi-clock-history me-1"></i>区間記録推移
    </div>
</div>

<!-- ペース分析タブ -->
<div id="paceTab" class="tab-content active">
    <div class="filter-card">
        <div class="row g-3">
            <div class="col-12 col-md-6">
                <label for="legSelect">区間</label>
                <select id="legSelect" class="form-select">
                    {% for leg in legs %}
                    <option value="{{ leg }}">{{ leg.replace('～', ' ～ ') }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-6">
                <label for="positionSelect">順位</label>
                <select id="positionSelect" class="form-select">
                    {% for pos in positions %}
                    <option value="{{ pos }}">{{ pos }}位</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div id="avgPaceInfo" class="avg-pace-info" style="display: none;">
        対象順位の区間 1km平均ペース: <span id="avgPaceValue">-</span> /km
    </div>

    <div id="paceLoading" class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2">データを読み込み中...</div>
    </div>

    <div id="paceError" class="error-message" style="display: none;"></div>

    <div id="paceResults" class="results-table table-responsive" style="display: none;">
        <table>
            <thead>
                <tr>
                    <th>チーム</th>
                    <th>回数</th>
                    <th>名前</th>
                    <th>年齢</th>
                    <th>所属</th>
                    <th>順位</th>
                    <th>時間</th>
                    <th>距離</th>
                    <th>気温</th>
                    <th>平均タイム</th>
                </tr>
            </thead>
            <tbody id="paceResultsBody">
            </tbody>
        </table>
    </div>
</div>

<!-- チーム別区間一覧タブ -->
<div id="teamTab" class="tab-content">
    <div class="filter-card">
        <div class="row g-3">
            <div class="col-12 col-md-6">
                <label for="teamSelect">チーム名</label>
                <select id="teamSelect" class="form-select">
                    {% for team in teams %}
                    <option value="{{ team }}">{{ team }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-6">
                <label for="editionSelect">大会回数</label>
                <select id="editionSelect" class="form-select">
                    {% for edition in editions %}
                    <option value="{{ edition }}">第{{ edition }}回</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div id="teamLoading" class="loading" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2">データを読み込み中...</div>
    </div>

    <div id="teamError" class="error-message" style="display: none;"></div>

    <div id="teamResults" class="results-table table-responsive" style="display: none;">
        <table>
            <thead>
                <tr>
                    <th>区間</th>
                    <th>名前</th>
                    <th>生年</th>
                    <th>アルファベット</th>
                    <th>所属</th>
                    <th>順位</th>
                    <th>時間</th>
                </tr>
            </thead>
            <tbody id="teamResultsBody">
            </tbody>
        </table>
    </div>
</div>

<!-- チーム区間記録推移タブ -->
<div id="sectionTab" class="tab-content">
    <div class="filter-card">
        <div class="row g-3">
            <div class="col-12 col-md-6">
                <label for="sectionTeamSelect">チーム名</label>
                <select id="sectionTeamSelect" class="form-select">
                    {% for team in teams %}
                    <option value="{{ team }}">{{ team }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-6">
                <label for="sectionLegSelect">区間</label>
                <select id="sectionLegSelect" class="form-select">
                    {% for leg in legs %}
                    <option value="{{ leg }}">{{ leg.replace('～', ' ～ ') }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div id="sectionLoading" class="loading" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2">データを読み込み中...</div>
    </div>

    <div id="sectionError" class="error-message" style="display: none;"></div>

    <div id="sectionResults" class="results-table table-responsive" style="display: none;">
        <table>
            <thead>
                <tr>
                    <th>回数</th>
                    <th>名前</th>
                    <th>生年</th>
                    <th>所属</th>
                    <th>順位</th>
                    <th>時間</th>
                    <th>距離</th>
                    <th>気温</th>
                    <th>平均タイム</th>
                </tr>
            </thead>
            <tbody id="sectionResultsBody">
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // タブ切り替え
    const tabs = document.querySelectorAll('.analysis-tab');
    const paceTab = document.getElementById('paceTab');
    const teamTab = document.getElementById('teamTab');
    const sectionTab = document.getElementById('sectionTab');

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            const tabName = this.getAttribute('data-tab');
            paceTab.classList.remove('active');
            teamTab.classList.remove('active');
            sectionTab.classList.remove('active');

            if (tabName === 'pace') {
                paceTab.classList.add('active');
            } else if (tabName === 'team') {
                teamTab.classList.add('active');
                fetchTeamData();
            } else if (tabName === 'section') {
                sectionTab.classList.add('active');
                fetchSectionData();
            }
        });
    });

    // ========== ペース分析 ==========
    const legSelect = document.getElementById('legSelect');
    const positionSelect = document.getElementById('positionSelect');
    const paceLoading = document.getElementById('paceLoading');
    const paceError = document.getElementById('paceError');
    const paceResults = document.getElementById('paceResults');
    const paceResultsBody = document.getElementById('paceResultsBody');
    const avgPaceInfo = document.getElementById('avgPaceInfo');
    const avgPaceValue = document.getElementById('avgPaceValue');

    legSelect.addEventListener('change', fetchPaceData);
    positionSelect.addEventListener('change', fetchPaceData);

    fetchPaceData();

    function fetchPaceData() {
        const leg = legSelect.value;
        const position = positionSelect.value;

        paceLoading.style.display = 'block';
        paceError.style.display = 'none';
        paceResults.style.display = 'none';
        avgPaceInfo.style.display = 'none';

        fetch(`/api/pace_analysis?leg=${encodeURIComponent(leg)}&position=${encodeURIComponent(position)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showPaceError(data.error);
                } else {
                    showPaceResults(data.data);
                }
            })
            .catch(error => {
                showPaceError('データの取得に失敗しました: ' + error.message);
            });
    }

    function showPaceError(message) {
        paceLoading.style.display = 'none';
        paceError.style.display = 'block';
        paceError.textContent = message;
        paceResults.style.display = 'none';
        avgPaceInfo.style.display = 'none';
    }

    function showPaceResults(data) {
        paceLoading.style.display = 'none';
        paceError.style.display = 'none';

        if (!data || data.length === 0) {
            showPaceError('該当するデータがありません');
            return;
        }

        // 最速タイムを探す
        let fastestAvgTimeSeconds = Infinity;
        let fastestIndex = -1;
        data.forEach((item, index) => {
            const seconds = convertTimeToSeconds(item.avg_time);
            if (seconds > 0 && seconds < fastestAvgTimeSeconds) {
                fastestAvgTimeSeconds = seconds;
                fastestIndex = index;
            }
        });

        // 平均ペース計算
        let totalSeconds = 0;
        let validCount = 0;
        data.forEach(item => {
            const seconds = convertTimeToSeconds(item.avg_time);
            if (seconds > 0) {
                totalSeconds += seconds;
                validCount++;
            }
        });

        if (validCount > 0) {
            const avgSeconds = totalSeconds / validCount;
            const avgMinutes = Math.floor(avgSeconds / 60);
            const avgSecs = Math.round(avgSeconds % 60);
            avgPaceValue.textContent = avgMinutes + ':' + (avgSecs < 10 ? '0' : '') + avgSecs;
            avgPaceInfo.style.display = 'block';
        } else {
            avgPaceInfo.style.display = 'none';
        }

        // テーブル生成
        paceResultsBody.innerHTML = '';
        data.forEach((item, index) => {
            const tr = document.createElement('tr');

            const teamClass = 'team-' + item.team.replace(/\s+/g, '');
            tr.innerHTML = `
                <td class="${teamClass}">${item.team}</td>
                <td>${item.edition}</td>
                <td>${item.name}</td>
                <td>${item.year_of_birth}</td>
                <td>${item.affiliation}</td>
                <td>${item.rank}</td>
                <td>${item.time}</td>
                <td>${item.distance}</td>
                <td class="${getTemperatureClass(item.temperature)}">${item.temperature}</td>
                <td class="${index === fastestIndex ? 'fastest-time' : ''}">${item.avg_time}</td>
            `;
            paceResultsBody.appendChild(tr);
        });

        paceResults.style.display = 'block';
    }

    // ========== チーム別区間一覧 ==========
    const teamSelect = document.getElementById('teamSelect');
    const editionSelect = document.getElementById('editionSelect');
    const teamLoading = document.getElementById('teamLoading');
    const teamError = document.getElementById('teamError');
    const teamResults = document.getElementById('teamResults');
    const teamResultsBody = document.getElementById('teamResultsBody');

    teamSelect.addEventListener('change', fetchTeamData);
    editionSelect.addEventListener('change', fetchTeamData);

    function fetchTeamData() {
        const team = teamSelect.value;
        const edition = editionSelect.value;

        teamLoading.style.display = 'block';
        teamError.style.display = 'none';
        teamResults.style.display = 'none';

        fetch(`/api/team_sections?team=${encodeURIComponent(team)}&edition=${encodeURIComponent(edition)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showTeamError(data.error);
                } else {
                    showTeamResults(data.data);
                }
            })
            .catch(error => {
                showTeamError('データの取得に失敗しました: ' + error.message);
            });
    }

    function showTeamError(message) {
        teamLoading.style.display = 'none';
        teamError.style.display = 'block';
        teamError.textContent = message;
        teamResults.style.display = 'none';
    }

    function showTeamResults(data) {
        teamLoading.style.display = 'none';
        teamError.style.display = 'none';

        if (!data || data.length === 0) {
            showTeamError('該当するデータがありません');
            return;
        }

        // テーブル生成
        teamResultsBody.innerHTML = '';
        data.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.section}</td>
                <td>${item.name}</td>
                <td>${item.year_of_birth}</td>
                <td>${item.name_alphabet}</td>
                <td>${item.affiliation}</td>
                <td>${item.rank}</td>
                <td>${item.time}</td>
            `;
            teamResultsBody.appendChild(tr);
        });

        teamResults.style.display = 'block';
    }

    // ========== チーム区間記録推移 ==========
    const sectionTeamSelect = document.getElementById('sectionTeamSelect');
    const sectionLegSelect = document.getElementById('sectionLegSelect');
    const sectionLoading = document.getElementById('sectionLoading');
    const sectionError = document.getElementById('sectionError');
    const sectionResults = document.getElementById('sectionResults');
    const sectionResultsBody = document.getElementById('sectionResultsBody');

    sectionTeamSelect.addEventListener('change', fetchSectionData);
    sectionLegSelect.addEventListener('change', fetchSectionData);

    function fetchSectionData() {
        const team = sectionTeamSelect.value;
        const leg = sectionLegSelect.value;

        sectionLoading.style.display = 'block';
        sectionError.style.display = 'none';
        sectionResults.style.display = 'none';

        fetch(`/api/team_section_all_editions?team=${encodeURIComponent(team)}&leg=${encodeURIComponent(leg)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showSectionError(data.error);
                } else {
                    showSectionResults(data.data);
                }
            })
            .catch(error => {
                showSectionError('データの取得に失敗しました: ' + error.message);
            });
    }

    function showSectionError(message) {
        sectionLoading.style.display = 'none';
        sectionError.style.display = 'block';
        sectionError.textContent = message;
        sectionResults.style.display = 'none';
    }

    function showSectionResults(data) {
        sectionLoading.style.display = 'none';
        sectionError.style.display = 'none';

        if (!data || data.length === 0) {
            showSectionError('該当するデータがありません');
            return;
        }

        // 最速タイムを探す
        let fastestAvgTimeSeconds = Infinity;
        let fastestIndex = -1;
        data.forEach((item, index) => {
            const seconds = convertTimeToSeconds(item.avg_time);
            if (seconds > 0 && seconds < fastestAvgTimeSeconds) {
                fastestAvgTimeSeconds = seconds;
                fastestIndex = index;
            }
        });

        // テーブル生成
        sectionResultsBody.innerHTML = '';
        data.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>第${item.edition}回</td>
                <td>${item.name}</td>
                <td>${item.year_of_birth}</td>
                <td>${item.affiliation}</td>
                <td>${item.rank}</td>
                <td>${item.time}</td>
                <td>${item.distance}</td>
                <td class="${getTemperatureClass(item.temperature)}">${item.temperature}</td>
                <td class="${index === fastestIndex ? 'fastest-time' : ''}">${item.avg_time}</td>
            `;
            sectionResultsBody.appendChild(tr);
        });

        sectionResults.style.display = 'block';
    }

    // ========== ユーティリティ関数 ==========
    function convertTimeToSeconds(timeStr) {
        if (!timeStr || timeStr === 'N/A') return 0;
        const parts = timeStr.split(':').map(Number);
        if (parts.length === 3) {
            return parts[0] * 3600 + parts[1] * 60 + parts[2];
        } else if (parts.length === 2) {
            return parts[0] * 60 + parts[1];
        }
        return 0;
    }

    function getTemperatureClass(temp) {
        const t = parseFloat(temp);
        if (isNaN(t)) return '';
        if (t <= 5) return 'temp-very-cold';
        if (t <= 10) return 'temp-cold';
        if (t <= 15) return 'temp-cool';
        if (t <= 20) return 'temp-warm';
        if (t <= 25) return 'temp-hot';
        if (t <= 30) return 'temp-very-hot';
        return 'temp-extreme';
    }
});
</script>
{% endblock %}
