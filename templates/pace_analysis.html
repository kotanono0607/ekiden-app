{% extends "base.html" %}

{% block title %}分析 - 県縦断駅伝{% endblock %}

{% block extra_css %}
<style>
    .analysis-header {
        background: var(--primary-gradient);
        color: white;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
    }
    .analysis-header h1 {
        font-size: 1.3rem;
        margin: 0;
    }

    /* タブナビゲーション */
    .analysis-tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 12px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .analysis-tab {
        flex: 1;
        padding: 10px 8px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-muted);
        transition: all 0.2s;
        white-space: nowrap;
        min-width: 0;
    }
    .analysis-tab i {
        display: none;
    }
    .analysis-tab:hover {
        background: var(--border-color);
    }
    .analysis-tab.active {
        background: var(--primary-gradient);
        border-color: transparent;
        color: white;
    }

    .filter-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .filter-card label {
        font-weight: 600;
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 4px;
        display: block;
    }
    .filter-card select {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.9rem;
        background-color: var(--input-bg);
        color: var(--text-color);
    }
    .avg-pace-info {
        background: linear-gradient(135deg, #6B3A3A 0%, #8B4513 100%);
        color: white;
        padding: 12px;
        border-radius: 12px;
        margin-bottom: 12px;
        font-size: 0.95rem;
        text-align: center;
    }

    /* カードリスト（モバイル用） */
    .result-cards {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .result-card {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        border-left: 4px solid #6B3A3A;
    }
    .result-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .result-card-team {
        font-weight: 600;
        font-size: 0.85rem;
        padding: 2px 8px;
        border-radius: 4px;
    }
    .result-card-edition {
        font-size: 0.75rem;
        color: var(--text-muted);
    }
    .result-card-main {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 6px;
    }
    .result-card-name {
        font-size: 1rem;
        font-weight: 600;
    }
    .result-card-time {
        font-size: 1.1rem;
        font-weight: bold;
        color: #6B3A3A;
    }
    .result-card-details {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        font-size: 0.75rem;
        color: var(--text-muted);
    }
    .result-card-details span {
        display: flex;
        align-items: center;
        gap: 2px;
    }
    .result-card-avg {
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        background: #f0f0f0;
    }
    [data-theme="dark"] .result-card-avg {
        background: #333;
    }
    .result-card.fastest .result-card-avg {
        background: #ffdd1a;
        color: #333;
    }

    /* チーム別背景色（襷の色） */
    .team-南陽東置賜 { background-color: #6B3A3A; color: white; }  /* 海老茶 */
    .team-長井西置賜 { background-color: #FFB6C1; color: #333; }   /* 桃色 */
    .team-上山 { background-color: #FF8C00; color: white; }        /* 橙色 */
    .team-山形 { background-color: #8B008B; color: white; }        /* 紫色 */
    .team-天童東村山 { background-color: #87CEEB; color: #333; }   /* 水色 */
    .team-寒河江西村山 { background-color: #191970; color: white; } /* 紺色 */
    .team-北村山 { background-color: #90EE90; color: #333; }       /* 薄緑 */
    .team-新庄最上 { background-color: #C8A2C8; color: #333; }     /* 藤色 */
    .team-鶴岡田川 { background-color: #FFD700; color: #333; }     /* 黄色 */
    .team-酒田飽海 { background-color: #006400; color: white; }    /* 濃緑 */
    .team-米沢 { background-color: #DC143C; color: white; }        /* 赤色 */

    /* 気温背景色 */
    .temp-very-cold { background-color: #1E90FF; color: white; }
    .temp-cold { background-color: #00BFFF; color: white; }
    .temp-cool { background-color: #b3ecff; color: #333; }
    .temp-warm { background-color: #ffd4cc; color: #333; }
    .temp-hot { background-color: #ff9380; color: #333; }
    .temp-very-hot { background-color: #FF4500; color: white; }
    .temp-extreme { background-color: #B22222; color: white; }

    .loading {
        text-align: center;
        padding: 30px;
        color: var(--text-muted);
    }
    .loading .spinner-border {
        width: 1.5rem;
        height: 1.5rem;
    }
    .error-message {
        background: #fee2e2;
        color: #dc2626;
        padding: 12px;
        border-radius: 8px;
        text-align: center;
        font-size: 0.9rem;
    }
    [data-theme="dark"] .error-message {
        background: rgba(220, 38, 38, 0.2);
    }

    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }

    /* デスクトップ用タブアイコン表示 */
    @media (min-width: 768px) {
        .analysis-tab i {
            display: inline;
        }
        .analysis-tab {
            font-size: 0.9rem;
            padding: 12px 16px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analysis-header">
    <h1><i class="bi bi-graph-up me-2"></i>県縦断駅伝分析</h1>
</div>

<!-- タブナビゲーション -->
<div class="analysis-tabs">
    <div class="analysis-tab active" data-tab="pace">
        <i class="bi bi-speedometer2 me-1"></i>ペース分析
    </div>
    <div class="analysis-tab" data-tab="team">
        <i class="bi bi-people me-1"></i>チーム別区間
    </div>
    <div class="analysis-tab" data-tab="section">
        <i class="bi bi-clock-history me-1"></i>区間記録推移
    </div>
</div>

<!-- ペース分析タブ -->
<div id="paceTab" class="tab-content active">
    <div class="filter-card">
        <div class="row g-3">
            <div class="col-12 col-md-6">
                <label for="legSelect">区間</label>
                <select id="legSelect" class="form-select">
                    {% for leg in legs %}
                    <option value="{{ leg }}">{{ leg.replace('～', ' ～ ') }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-6">
                <label for="positionSelect">順位</label>
                <select id="positionSelect" class="form-select">
                    {% for pos in positions %}
                    <option value="{{ pos }}">{{ pos }}位</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div id="avgPaceInfo" class="avg-pace-info" style="display: none;">
        対象順位の区間 1km平均ペース: <span id="avgPaceValue">-</span> /km
    </div>

    <div id="paceLoading" class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2">データを読み込み中...</div>
    </div>

    <div id="paceError" class="error-message" style="display: none;"></div>

    <div id="paceResults" class="result-cards" style="display: none;"></div>
</div>

<!-- チーム別区間一覧タブ -->
<div id="teamTab" class="tab-content">
    <div class="filter-card">
        <div class="row g-3">
            <div class="col-12 col-md-6">
                <label for="teamSelect">チーム名</label>
                <select id="teamSelect" class="form-select">
                    {% for team in teams %}
                    <option value="{{ team }}">{{ team }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-6">
                <label for="editionSelect">大会回数</label>
                <select id="editionSelect" class="form-select">
                    {% for edition in editions %}
                    <option value="{{ edition }}">第{{ edition }}回</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div id="teamLoading" class="loading" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2">データを読み込み中...</div>
    </div>

    <div id="teamError" class="error-message" style="display: none;"></div>

    <div id="teamResults" class="result-cards" style="display: none;"></div>
</div>

<!-- チーム区間記録推移タブ -->
<div id="sectionTab" class="tab-content">
    <div class="filter-card">
        <div class="row g-3">
            <div class="col-12 col-md-6">
                <label for="sectionTeamSelect">チーム名</label>
                <select id="sectionTeamSelect" class="form-select">
                    {% for team in teams %}
                    <option value="{{ team }}">{{ team }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-6">
                <label for="sectionLegSelect">区間</label>
                <select id="sectionLegSelect" class="form-select">
                    {% for leg in legs %}
                    <option value="{{ leg }}">{{ leg.replace('～', ' ～ ') }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div id="sectionLoading" class="loading" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2">データを読み込み中...</div>
    </div>

    <div id="sectionError" class="error-message" style="display: none;"></div>

    <div id="sectionResults" class="result-cards" style="display: none;"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // タブ切り替え
    const tabs = document.querySelectorAll('.analysis-tab');
    const paceTab = document.getElementById('paceTab');
    const teamTab = document.getElementById('teamTab');
    const sectionTab = document.getElementById('sectionTab');

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            const tabName = this.getAttribute('data-tab');
            paceTab.classList.remove('active');
            teamTab.classList.remove('active');
            sectionTab.classList.remove('active');

            if (tabName === 'pace') {
                paceTab.classList.add('active');
            } else if (tabName === 'team') {
                teamTab.classList.add('active');
                fetchTeamData();
            } else if (tabName === 'section') {
                sectionTab.classList.add('active');
                fetchSectionData();
            }
        });
    });

    // ========== ペース分析 ==========
    const legSelect = document.getElementById('legSelect');
    const positionSelect = document.getElementById('positionSelect');
    const paceLoading = document.getElementById('paceLoading');
    const paceError = document.getElementById('paceError');
    const paceResults = document.getElementById('paceResults');
    const avgPaceInfo = document.getElementById('avgPaceInfo');
    const avgPaceValue = document.getElementById('avgPaceValue');

    legSelect.addEventListener('change', fetchPaceData);
    positionSelect.addEventListener('change', fetchPaceData);

    fetchPaceData();

    function fetchPaceData() {
        const leg = legSelect.value;
        const position = positionSelect.value;

        paceLoading.style.display = 'block';
        paceError.style.display = 'none';
        paceResults.style.display = 'none';
        avgPaceInfo.style.display = 'none';

        fetch(`/api/pace_analysis?leg=${encodeURIComponent(leg)}&position=${encodeURIComponent(position)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showPaceError(data.error);
                } else {
                    showPaceResults(data.data);
                }
            })
            .catch(error => {
                showPaceError('データの取得に失敗しました: ' + error.message);
            });
    }

    function showPaceError(message) {
        paceLoading.style.display = 'none';
        paceError.style.display = 'block';
        paceError.textContent = message;
        paceResults.style.display = 'none';
        avgPaceInfo.style.display = 'none';
    }

    function showPaceResults(data) {
        paceLoading.style.display = 'none';
        paceError.style.display = 'none';

        if (!data || data.length === 0) {
            showPaceError('該当するデータがありません');
            return;
        }

        // 最速タイムを探す
        let fastestAvgTimeSeconds = Infinity;
        let fastestIndex = -1;
        data.forEach((item, index) => {
            const seconds = convertTimeToSeconds(item.avg_time);
            if (seconds > 0 && seconds < fastestAvgTimeSeconds) {
                fastestAvgTimeSeconds = seconds;
                fastestIndex = index;
            }
        });

        // 平均ペース計算
        let totalSeconds = 0;
        let validCount = 0;
        data.forEach(item => {
            const seconds = convertTimeToSeconds(item.avg_time);
            if (seconds > 0) {
                totalSeconds += seconds;
                validCount++;
            }
        });

        if (validCount > 0) {
            const avgSeconds = totalSeconds / validCount;
            const avgMinutes = Math.floor(avgSeconds / 60);
            const avgSecs = Math.round(avgSeconds % 60);
            avgPaceValue.textContent = avgMinutes + ':' + (avgSecs < 10 ? '0' : '') + avgSecs;
            avgPaceInfo.style.display = 'block';
        } else {
            avgPaceInfo.style.display = 'none';
        }

        // カード生成
        paceResults.innerHTML = '';
        data.forEach((item, index) => {
            const card = document.createElement('div');
            const teamClass = 'team-' + item.team.replace(/\s+/g, '');
            const isFastest = index === fastestIndex;
            card.className = 'result-card' + (isFastest ? ' fastest' : '');
            card.innerHTML = `
                <div class="result-card-header">
                    <span class="result-card-team ${teamClass}">${item.team}</span>
                    <span class="result-card-edition">第${item.edition}回</span>
                </div>
                <div class="result-card-main">
                    <span class="result-card-name">${item.name}</span>
                    <span class="result-card-time">${item.time}</span>
                </div>
                <div class="result-card-details">
                    <span>${item.year_of_birth}生</span>
                    <span>${item.affiliation}</span>
                    <span>${item.rank}位</span>
                    <span>${item.distance}km</span>
                    <span class="${getTemperatureClass(item.temperature)}" style="padding:1px 4px;border-radius:3px;">${item.temperature}℃</span>
                    <span class="result-card-avg">${item.avg_time}/km</span>
                </div>
            `;
            paceResults.appendChild(card);
        });

        paceResults.style.display = 'flex';
    }

    // ========== チーム別区間一覧 ==========
    const teamSelect = document.getElementById('teamSelect');
    const editionSelect = document.getElementById('editionSelect');
    const teamLoading = document.getElementById('teamLoading');
    const teamError = document.getElementById('teamError');
    const teamResults = document.getElementById('teamResults');

    teamSelect.addEventListener('change', fetchTeamData);
    editionSelect.addEventListener('change', fetchTeamData);

    function fetchTeamData() {
        const team = teamSelect.value;
        const edition = editionSelect.value;

        teamLoading.style.display = 'block';
        teamError.style.display = 'none';
        teamResults.style.display = 'none';

        fetch(`/api/team_sections?team=${encodeURIComponent(team)}&edition=${encodeURIComponent(edition)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showTeamError(data.error);
                } else {
                    showTeamResults(data.data);
                }
            })
            .catch(error => {
                showTeamError('データの取得に失敗しました: ' + error.message);
            });
    }

    function showTeamError(message) {
        teamLoading.style.display = 'none';
        teamError.style.display = 'block';
        teamError.textContent = message;
        teamResults.style.display = 'none';
    }

    function showTeamResults(data) {
        teamLoading.style.display = 'none';
        teamError.style.display = 'none';

        if (!data || data.length === 0) {
            showTeamError('該当するデータがありません');
            return;
        }

        // カード生成
        teamResults.innerHTML = '';
        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'result-card';
            // 区間番号を抽出して色分け
            const sectionNum = item.section.match(/第(\d+)区/);
            const sectionColor = sectionNum ? `hsl(${(parseInt(sectionNum[1]) * 12) % 360}, 60%, 50%)` : '#667eea';
            card.style.borderLeftColor = sectionColor;
            card.innerHTML = `
                <div class="result-card-header">
                    <span class="result-card-edition" style="font-size:0.85rem;color:var(--text-color);font-weight:600;">${item.section}</span>
                    <span class="result-card-edition">${item.rank}位</span>
                </div>
                <div class="result-card-main">
                    <span class="result-card-name">${item.name}</span>
                    <span class="result-card-time">${item.time}</span>
                </div>
                <div class="result-card-details">
                    <span>${item.year_of_birth}生</span>
                    <span>${item.affiliation}</span>
                </div>
            `;
            teamResults.appendChild(card);
        });

        teamResults.style.display = 'flex';
    }

    // ========== チーム区間記録推移 ==========
    const sectionTeamSelect = document.getElementById('sectionTeamSelect');
    const sectionLegSelect = document.getElementById('sectionLegSelect');
    const sectionLoading = document.getElementById('sectionLoading');
    const sectionError = document.getElementById('sectionError');
    const sectionResults = document.getElementById('sectionResults');

    sectionTeamSelect.addEventListener('change', fetchSectionData);
    sectionLegSelect.addEventListener('change', fetchSectionData);

    function fetchSectionData() {
        const team = sectionTeamSelect.value;
        const leg = sectionLegSelect.value;

        sectionLoading.style.display = 'block';
        sectionError.style.display = 'none';
        sectionResults.style.display = 'none';

        fetch(`/api/team_section_all_editions?team=${encodeURIComponent(team)}&leg=${encodeURIComponent(leg)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showSectionError(data.error);
                } else {
                    showSectionResults(data.data);
                }
            })
            .catch(error => {
                showSectionError('データの取得に失敗しました: ' + error.message);
            });
    }

    function showSectionError(message) {
        sectionLoading.style.display = 'none';
        sectionError.style.display = 'block';
        sectionError.textContent = message;
        sectionResults.style.display = 'none';
    }

    function showSectionResults(data) {
        sectionLoading.style.display = 'none';
        sectionError.style.display = 'none';

        if (!data || data.length === 0) {
            showSectionError('該当するデータがありません');
            return;
        }

        // 最速タイムを探す
        let fastestAvgTimeSeconds = Infinity;
        let fastestIndex = -1;
        data.forEach((item, index) => {
            const seconds = convertTimeToSeconds(item.avg_time);
            if (seconds > 0 && seconds < fastestAvgTimeSeconds) {
                fastestAvgTimeSeconds = seconds;
                fastestIndex = index;
            }
        });

        // カード生成
        sectionResults.innerHTML = '';
        data.forEach((item, index) => {
            const card = document.createElement('div');
            const isFastest = index === fastestIndex;
            card.className = 'result-card' + (isFastest ? ' fastest' : '');
            card.innerHTML = `
                <div class="result-card-header">
                    <span class="result-card-edition" style="font-size:0.9rem;color:var(--text-color);font-weight:600;">第${item.edition}回</span>
                    <span class="result-card-edition">${item.rank}位</span>
                </div>
                <div class="result-card-main">
                    <span class="result-card-name">${item.name}</span>
                    <span class="result-card-time">${item.time}</span>
                </div>
                <div class="result-card-details">
                    <span>${item.year_of_birth}生</span>
                    <span>${item.affiliation}</span>
                    <span>${item.distance}km</span>
                    <span class="${getTemperatureClass(item.temperature)}" style="padding:1px 4px;border-radius:3px;">${item.temperature}℃</span>
                    <span class="result-card-avg">${item.avg_time}/km</span>
                </div>
            `;
            sectionResults.appendChild(card);
        });

        sectionResults.style.display = 'flex';
    }

    // ========== ユーティリティ関数 ==========
    function convertTimeToSeconds(timeStr) {
        if (!timeStr || timeStr === 'N/A') return 0;
        const parts = timeStr.split(':').map(Number);
        if (parts.length === 3) {
            return parts[0] * 3600 + parts[1] * 60 + parts[2];
        } else if (parts.length === 2) {
            return parts[0] * 60 + parts[1];
        }
        return 0;
    }

    function getTemperatureClass(temp) {
        const t = parseFloat(temp);
        if (isNaN(t)) return '';
        if (t <= 5) return 'temp-very-cold';
        if (t <= 10) return 'temp-cold';
        if (t <= 15) return 'temp-cool';
        if (t <= 20) return 'temp-warm';
        if (t <= 25) return 'temp-hot';
        if (t <= 30) return 'temp-very-hot';
        return 'temp-extreme';
    }
});
</script>
{% endblock %}
