{% extends "base.html" %}

{% block title %}記録編集 - 駅伝アプリ{% endblock %}

{% block extra_css %}
<style>
    .form-header {
        background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        color: white;
        padding: 20px 16px;
        margin: -1rem -12px 0 -12px;
        text-align: center;
    }
    .form-header h5 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
    }
    .form-section {
        background: var(--card-bg);
        border-radius: 12px;
        margin: 16px 0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    .section-title {
        padding: 12px 16px;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-muted);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .section-body {
        padding: 16px;
    }
    .form-label {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-muted);
        margin-bottom: 6px;
    }
    .form-control, .form-select {
        font-size: 16px;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-color);
        color: var(--text-color);
    }
    .form-control:focus, .form-select:focus {
        border-color: #ed8936;
        box-shadow: 0 0 0 3px rgba(237, 137, 54, 0.15);
    }
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        color: var(--text-muted);
        text-decoration: none;
        font-size: 14px;
        padding: 8px 0;
    }
    .submit-area {
        position: sticky;
        bottom: 0;
        background: var(--card-bg);
        padding: 16px;
        margin: 16px -12px -1rem -12px;
        border-top: 1px solid var(--border-color);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .submit-btn {
        padding: 14px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 8px;
    }

    /* 大会タイプ選択 */
    .type-selector {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
    }
    .type-btn {
        padding: 14px 8px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        background: var(--card-bg);
        font-size: 14px;
        font-weight: 600;
        color: var(--text-muted);
        text-align: center;
        cursor: pointer;
        transition: all 0.15s;
    }
    .type-btn i {
        display: block;
        font-size: 24px;
        margin-bottom: 6px;
    }
    .type-btn:hover {
        border-color: #ed8936;
    }
    .type-btn.selected {
        border-color: #ed8936;
        background: rgba(237, 137, 54, 0.1);
        color: #dd6b20;
    }
    .type-btn.ekiden.selected {
        border-color: #ED8936;
        background: rgba(237, 137, 54, 0.1);
        color: #DD6B20;
    }
    .type-btn.track.selected {
        border-color: #3182CE;
        background: rgba(49, 130, 206, 0.1);
        color: #2B6CB0;
    }
    .type-btn.road.selected {
        border-color: #38A169;
        background: rgba(56, 161, 105, 0.1);
        color: #2F855A;
    }

    /* 種目グリッド */
    .event-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
    }
    .event-btn {
        padding: 10px 6px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--card-bg);
        font-size: 13px;
        font-weight: 500;
        color: var(--text-color);
        text-align: center;
        cursor: pointer;
        transition: all 0.15s;
    }
    .event-btn:hover {
        border-color: #ed8936;
        color: #ed8936;
    }
    .event-btn.selected {
        border-color: #ed8936;
        background: rgba(237, 137, 54, 0.1);
        color: #dd6b20;
    }

    /* 区間グリッド */
    .section-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 6px;
    }
    .section-btn {
        padding: 10px 4px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--card-bg);
        font-size: 12px;
        font-weight: 500;
        color: var(--text-color);
        text-align: center;
        cursor: pointer;
        transition: all 0.15s;
    }
    .section-btn:hover {
        border-color: #ED8936;
    }
    .section-btn.selected {
        border-color: #ED8936;
        background: rgba(237, 137, 54, 0.1);
        color: #DD6B20;
    }

    /* 入力グループ */
    .input-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    /* 条件表示 */
    .conditional-section {
        display: none;
    }
    .conditional-section.active {
        display: block;
    }

    /* タイム入力 */
    .time-input {
        text-align: center;
        font-size: 24px;
        font-weight: 600;
        font-family: 'SF Mono', 'Consolas', monospace;
        padding: 16px 12px;
    }
    .time-input-group {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }
    .time-field {
        width: 70px;
        text-align: center;
        font-size: 28px;
        font-weight: 600;
        font-family: 'SF Mono', 'Consolas', monospace;
        padding: 12px 8px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        background: var(--card-bg);
        color: var(--text-color);
    }
    .time-field:focus {
        border-color: #ed8936;
        outline: none;
        box-shadow: 0 0 0 3px rgba(237, 137, 54, 0.15);
    }
    .time-separator {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-muted);
    }
    .time-label {
        font-size: 11px;
        color: var(--text-muted);
        text-align: center;
        margin-top: 4px;
    }
    .time-field-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* 距離プリセット */
    .distance-presets {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 12px;
    }
    .distance-preset-btn {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        background: var(--card-bg);
        font-size: 13px;
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.15s;
    }
    .distance-preset-btn:hover {
        border-color: #ed8936;
        color: #ed8936;
    }
    .distance-preset-btn.selected {
        border-color: #ed8936;
        background: rgba(237, 137, 54, 0.1);
        color: #dd6b20;
    }

    /* ペース表示 */
    .pace-display {
        margin-top: 12px;
        padding: 12px;
        background: rgba(237, 137, 54, 0.1);
        border-radius: 8px;
        text-align: center;
        display: none;
    }
    .pace-display.active {
        display: block;
    }
    .pace-value {
        font-size: 20px;
        font-weight: 600;
        color: #dd6b20;
        font-family: 'SF Mono', 'Consolas', monospace;
    }
    .pace-label {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 2px;
    }

    /* 削除セクション */
    .delete-section {
        background: rgba(254, 178, 178, 0.1);
        border: 1px solid #feb2b2;
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
    }

    @media (min-width: 768px) {
        .submit-area {
            position: static;
            margin: 16px 0;
            padding: 0;
            background: transparent;
            border: none;
            display: flex;
            gap: 12px;
        }
        .submit-btn {
            padding: 14px 32px;
        }
    }
</style>
{% endblock %}

{% block content %}
<a href="/player/{{ record.player_id }}" class="back-link">
    <i class="bi bi-chevron-left"></i> 戻る
</a>

<div class="form-header">
    <h5><i class="bi bi-pencil"></i> 記録編集</h5>
</div>

<form action="/record/{{ record.row_index }}/edit" method="POST" id="recordForm">
    <!-- 選手選択 -->
    <div class="form-section">
        <div class="section-title">
            <i class="bi bi-person text-primary"></i> 選手
        </div>
        <div class="section-body">
            <select class="form-select" id="player_id" name="player_id" required>
                <option value="">選手を選択してください</option>
                {% for player in players %}
                <option value="{{ player.id }}" {% if record.player_id|string == player.id|string %}selected{% endif %}>
                    {{ player.name }}{% if player.affiliation %} ({{ player.affiliation }}){% endif %}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- 大会タイプ -->
    <div class="form-section">
        <div class="section-title">
            <i class="bi bi-tag text-info"></i> 大会タイプ
        </div>
        <div class="section-body">
            <input type="hidden" id="race_type" name="race_type" value="{{ record.race_type or '' }}">
            <div class="type-selector">
                <button type="button" class="type-btn ekiden {% if record.race_type == '駅伝' %}selected{% endif %}" data-type="駅伝">
                    <i class="bi bi-arrow-repeat"></i>
                    駅伝
                </button>
                <button type="button" class="type-btn track {% if record.race_type == 'トラック' %}selected{% endif %}" data-type="トラック">
                    <i class="bi bi-circle"></i>
                    トラック
                </button>
                <button type="button" class="type-btn road {% if record.race_type == 'ロード' %}selected{% endif %}" data-type="ロード">
                    <i class="bi bi-signpost-2"></i>
                    ロード
                </button>
            </div>
        </div>
    </div>

    <!-- 大会名 -->
    <div class="form-section">
        <div class="section-title">
            <i class="bi bi-trophy text-warning"></i> 大会名
        </div>
        <div class="section-body">
            <input type="text" class="form-control" id="race_name" name="race_name"
                   value="{{ record.race_name or '' }}"
                   placeholder="例: 第68回山形県縦断駅伝" list="race_suggestions">
            <datalist id="race_suggestions">
                <option value="第68回山形県縦断駅伝">
                <option value="第67回山形県縦断駅伝">
                <option value="第66回山形県縦断駅伝">
                <option value="山形県高校駅伝">
                <option value="東北高校駅伝">
                <option value="全国高校駅伝">
                <option value="山形県選手権">
                <option value="東北選手権">
                <option value="インターハイ">
            </datalist>
        </div>
    </div>

    <!-- 日付 -->
    <div class="form-section">
        <div class="section-title">
            <i class="bi bi-calendar3 text-info"></i> 日付
        </div>
        <div class="section-body">
            <input type="date" class="form-control" id="date" name="date" value="{{ record.date }}" required>
        </div>
    </div>

    <!-- 駅伝用：区間選択 -->
    <div class="form-section conditional-section {% if record.race_type == '駅伝' %}active{% endif %}" id="ekiden-section">
        <div class="section-title">
            <i class="bi bi-signpost text-warning"></i> 区間
        </div>
        <div class="section-body">
            <input type="hidden" id="section" name="section" value="{{ record.section or '' }}">
            <div class="section-grid">
                {% for i in range(1, 30) %}
                <button type="button" class="section-btn {% if record.section == i|string + '区' %}selected{% endif %}" data-section="{{ i }}区">{{ i }}区</button>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- トラック用：種目選択 -->
    <div class="form-section conditional-section {% if record.race_type == 'トラック' %}active{% endif %}" id="track-section">
        <div class="section-title">
            <i class="bi bi-flag text-primary"></i> 種目
        </div>
        <div class="section-body">
            <input type="hidden" id="event_track" name="event_track" value="{{ record.event or '' }}">
            <div class="event-grid">
                <button type="button" class="event-btn track-event {% if record.event == '800m' %}selected{% endif %}" data-event="800m">800m</button>
                <button type="button" class="event-btn track-event {% if record.event == '1500m' %}selected{% endif %}" data-event="1500m">1500m</button>
                <button type="button" class="event-btn track-event {% if record.event == '3000m' %}selected{% endif %}" data-event="3000m">3000m</button>
                <button type="button" class="event-btn track-event {% if record.event == '5000m' %}selected{% endif %}" data-event="5000m">5000m</button>
                <button type="button" class="event-btn track-event {% if record.event == '10000m' %}selected{% endif %}" data-event="10000m">10000m</button>
                <button type="button" class="event-btn track-event {% if record.event == '3000mSC' %}selected{% endif %}" data-event="3000mSC">3000mSC</button>
            </div>
        </div>
    </div>

    <!-- ロード用：種目選択 -->
    <div class="form-section conditional-section {% if record.race_type == 'ロード' %}active{% endif %}" id="road-section">
        <div class="section-title">
            <i class="bi bi-signpost-2 text-success"></i> 種目
        </div>
        <div class="section-body">
            <input type="hidden" id="event_road" name="event_road" value="{{ record.event or '' }}">
            <div class="event-grid">
                <button type="button" class="event-btn road-event {% if record.event == '5km' %}selected{% endif %}" data-event="5km">5km</button>
                <button type="button" class="event-btn road-event {% if record.event == '10km' %}selected{% endif %}" data-event="10km">10km</button>
                <button type="button" class="event-btn road-event {% if record.event == 'ハーフ' or record.event == 'ハーフマラソン' %}selected{% endif %}" data-event="ハーフ">ハーフ</button>
                <button type="button" class="event-btn road-event {% if record.event == 'フル' or record.event == 'マラソン' %}selected{% endif %}" data-event="フル">フル</button>
            </div>
        </div>
    </div>

    <!-- 統合された event フィールド -->
    <input type="hidden" id="event" name="event" value="{{ record.event or record.section or '' }}">

    <!-- 距離・順位 -->
    <div class="form-section conditional-section {% if record.race_type %}active{% endif %}" id="detail-section">
        <div class="section-title">
            <i class="bi bi-info-circle text-secondary"></i> 詳細情報
        </div>
        <div class="section-body">
            <!-- 距離プリセット -->
            <div class="distance-presets" id="distance-presets">
                <button type="button" class="distance-preset-btn" data-distance="3">3km</button>
                <button type="button" class="distance-preset-btn" data-distance="5">5km</button>
                <button type="button" class="distance-preset-btn" data-distance="7">7km</button>
                <button type="button" class="distance-preset-btn" data-distance="8">8km</button>
                <button type="button" class="distance-preset-btn" data-distance="10">10km</button>
                <button type="button" class="distance-preset-btn" data-distance="12">12km</button>
                <button type="button" class="distance-preset-btn" data-distance="15">15km</button>
                <button type="button" class="distance-preset-btn" data-distance="21.0975">ハーフ</button>
            </div>
            <div class="input-row">
                <div>
                    <label class="form-label">距離 (km)</label>
                    <input type="number" class="form-control" id="distance_km" name="distance_km"
                           value="{{ record.distance_km or '' }}"
                           placeholder="10.5" step="0.01" min="0">
                </div>
                <div>
                    <label class="form-label" id="rank-label">{% if record.race_type == '駅伝' %}区間順位{% else %}順位{% endif %}</label>
                    <input type="number" class="form-control" id="rank_in_section" name="rank_in_section"
                           value="{{ record.rank_in_section or '' }}"
                           placeholder="3" min="1">
                </div>
            </div>
        </div>
    </div>

    <!-- タイム -->
    <div class="form-section">
        <div class="section-title">
            <i class="bi bi-clock text-success"></i> タイム
        </div>
        <div class="section-body">
            <input type="hidden" id="time" name="time" value="{{ record.time }}">
            <div class="time-input-group">
                <div class="time-field-wrapper">
                    <input type="number" class="time-field" id="time_h" min="0" max="23" placeholder="0">
                    <span class="time-label">時</span>
                </div>
                <span class="time-separator">:</span>
                <div class="time-field-wrapper">
                    <input type="number" class="time-field" id="time_m" min="0" max="59" placeholder="00">
                    <span class="time-label">分</span>
                </div>
                <span class="time-separator">:</span>
                <div class="time-field-wrapper">
                    <input type="number" class="time-field" id="time_s" min="0" max="59" placeholder="00">
                    <span class="time-label">秒</span>
                </div>
            </div>
            <div class="pace-display" id="pace-display">
                <div class="pace-value" id="pace-value">--:--</div>
                <div class="pace-label">/km ペース</div>
            </div>
        </div>
    </div>

    <!-- メモ -->
    <div class="form-section">
        <div class="section-title">
            <i class="bi bi-chat-text text-secondary"></i> メモ
        </div>
        <div class="section-body">
            <textarea class="form-control" id="memo" name="memo" rows="2">{{ record.memo or '' }}</textarea>

            <!-- 削除 -->
            <div class="delete-section">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-danger"><i class="bi bi-trash"></i> この記録を削除</span>
                    <form action="/record/{{ record.row_index }}/delete" method="POST" style="margin:0;"
                          onsubmit="return confirm('この記録を削除しますか？');">
                        <button type="submit" class="btn btn-outline-danger btn-sm">
                            削除する
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 送信ボタン -->
    <div class="submit-area">
        <a href="/player/{{ record.player_id }}" class="btn btn-outline-secondary submit-btn">
            キャンセル
        </a>
        <button type="submit" class="btn btn-warning submit-btn text-white">
            <i class="bi bi-check-lg"></i> 更新
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// 大会タイプ選択
document.querySelectorAll('.type-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        const type = this.dataset.type;
        document.getElementById('race_type').value = type;

        // 条件表示の切り替え
        document.querySelectorAll('.conditional-section').forEach(s => s.classList.remove('active'));

        if (type === '駅伝') {
            document.getElementById('ekiden-section').classList.add('active');
            document.getElementById('detail-section').classList.add('active');
            document.getElementById('rank-label').textContent = '区間順位';
        } else if (type === 'トラック') {
            document.getElementById('track-section').classList.add('active');
            document.getElementById('detail-section').classList.add('active');
            document.getElementById('rank-label').textContent = '順位';
        } else if (type === 'ロード') {
            document.getElementById('road-section').classList.add('active');
            document.getElementById('detail-section').classList.add('active');
            document.getElementById('rank-label').textContent = '順位';
        }
    });
});

// 駅伝区間選択
document.querySelectorAll('.section-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.section-btn').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        document.getElementById('section').value = this.dataset.section;
        document.getElementById('event').value = this.dataset.section;
    });
});

// トラック種目選択
document.querySelectorAll('.track-event').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.track-event').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        document.getElementById('event_track').value = this.dataset.event;
        document.getElementById('event').value = this.dataset.event;
    });
});

// ロード種目選択
document.querySelectorAll('.road-event').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.road-event').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        document.getElementById('event_road').value = this.dataset.event;
        document.getElementById('event').value = this.dataset.event;
    });
});

// 距離プリセット選択
document.querySelectorAll('.distance-preset-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.distance-preset-btn').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        document.getElementById('distance_km').value = this.dataset.distance;
        calculatePace();
    });
});

// 距離入力時もペース計算
document.getElementById('distance_km').addEventListener('input', function() {
    const value = parseFloat(this.value);
    document.querySelectorAll('.distance-preset-btn').forEach(btn => {
        btn.classList.toggle('selected', parseFloat(btn.dataset.distance) === value);
    });
    calculatePace();
});

// タイム入力フィールドの処理
const timeFields = ['time_h', 'time_m', 'time_s'];
timeFields.forEach((fieldId, index) => {
    const field = document.getElementById(fieldId);

    field.addEventListener('input', function() {
        if (this.value.length >= 2 && index < timeFields.length - 1) {
            document.getElementById(timeFields[index + 1]).focus();
            document.getElementById(timeFields[index + 1]).select();
        }
        const max = parseInt(this.getAttribute('max'));
        if (parseInt(this.value) > max) {
            this.value = max;
        }
        updateTimeValue();
        calculatePace();
    });

    field.addEventListener('focus', function() {
        this.select();
    });

    field.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowUp') {
            e.preventDefault();
            const max = parseInt(this.getAttribute('max'));
            let val = parseInt(this.value) || 0;
            if (val < max) {
                this.value = val + 1;
                updateTimeValue();
                calculatePace();
            }
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            let val = parseInt(this.value) || 0;
            if (val > 0) {
                this.value = val - 1;
                updateTimeValue();
                calculatePace();
            }
        } else if (e.key === ':') {
            e.preventDefault();
            if (index < timeFields.length - 1) {
                document.getElementById(timeFields[index + 1]).focus();
            }
        }
    });
});

// タイム値を統合フィールドに反映
function updateTimeValue() {
    const h = parseInt(document.getElementById('time_h').value) || 0;
    const m = parseInt(document.getElementById('time_m').value) || 0;
    const s = parseInt(document.getElementById('time_s').value) || 0;

    let timeStr = '';
    if (h > 0) {
        timeStr = `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    } else {
        timeStr = `${m}:${s.toString().padStart(2, '0')}`;
    }
    document.getElementById('time').value = timeStr;
}

// ペース計算
function calculatePace() {
    const distance = parseFloat(document.getElementById('distance_km').value);
    const h = parseInt(document.getElementById('time_h').value) || 0;
    const m = parseInt(document.getElementById('time_m').value) || 0;
    const s = parseInt(document.getElementById('time_s').value) || 0;

    const totalSeconds = h * 3600 + m * 60 + s;

    if (distance > 0 && totalSeconds > 0) {
        const paceSeconds = totalSeconds / distance;
        const paceMin = Math.floor(paceSeconds / 60);
        const paceSec = Math.round(paceSeconds % 60);

        document.getElementById('pace-value').textContent =
            `${paceMin}:${paceSec.toString().padStart(2, '0')}`;
        document.getElementById('pace-display').classList.add('active');
    } else {
        document.getElementById('pace-display').classList.remove('active');
    }
}

// 初期値をパースしてタイムフィールドに設定
function parseInitialTime() {
    const timeValue = document.getElementById('time').value;
    if (timeValue) {
        const parts = timeValue.split(':');
        if (parts.length === 3) {
            document.getElementById('time_h').value = parseInt(parts[0]) || 0;
            document.getElementById('time_m').value = parseInt(parts[1]) || 0;
            document.getElementById('time_s').value = parseInt(parts[2]) || 0;
        } else if (parts.length === 2) {
            document.getElementById('time_h').value = 0;
            document.getElementById('time_m').value = parseInt(parts[0]) || 0;
            document.getElementById('time_s').value = parseInt(parts[1]) || 0;
        }
    }
}

// 初期距離プリセットをチェック
function checkInitialDistance() {
    const distance = parseFloat(document.getElementById('distance_km').value);
    if (distance) {
        document.querySelectorAll('.distance-preset-btn').forEach(btn => {
            btn.classList.toggle('selected', parseFloat(btn.dataset.distance) === distance);
        });
    }
}

// ページロード時の初期化
parseInitialTime();
checkInitialDistance();
calculatePace();

// フォーム送信前のバリデーション
document.getElementById('recordForm').addEventListener('submit', function(e) {
    const raceType = document.getElementById('race_type').value;
    const event = document.getElementById('event').value;

    updateTimeValue();
    const time = document.getElementById('time').value;

    if (!raceType) {
        e.preventDefault();
        alert('大会タイプを選択してください');
        return;
    }

    if (!event) {
        e.preventDefault();
        if (raceType === '駅伝') {
            alert('区間を選択してください');
        } else {
            alert('種目を選択してください');
        }
        return;
    }

    if (!time || time === '0:00') {
        e.preventDefault();
        alert('タイムを入力してください');
        return;
    }
});
</script>
{% endblock %}
