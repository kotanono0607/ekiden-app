{% extends "base.html" %}

{% block title %}記録登録 - 駅伝アプリ{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">選手一覧</a></li>
        <li class="breadcrumb-item active">記録登録</li>
    </ol>
</nav>

<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-stopwatch text-primary"></i> 記録登録</h5>
            </div>
            <div class="card-body">
                <form action="/record/add" method="POST">
                    <!-- 選手選択 -->
                    <div class="mb-3">
                        <label for="player_id" class="form-label">選手 <span class="text-danger">*</span></label>
                        <select class="form-select" id="player_id" name="player_id" required>
                            <option value="">選手を選択してください</option>
                            {% for player in players %}
                            <option value="{{ player.id }}" {% if selected_player_id == player.id|string %}selected{% endif %}>
                                {{ player.name }} ({{ player.group }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- 日付 -->
                    <div class="mb-3">
                        <label for="date" class="form-label">日付 <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="date" name="date"
                               value="{{ today }}" required>
                    </div>

                    <!-- 種目 -->
                    <div class="mb-3">
                        <label for="event" class="form-label">種目 <span class="text-danger">*</span></label>
                        <select class="form-select" id="event" name="event" required>
                            <option value="">種目を選択してください</option>
                            <optgroup label="トラック">
                                <option value="1500m">1500m</option>
                                <option value="3000m">3000m</option>
                                <option value="5000m">5000m</option>
                                <option value="10000m">10000m</option>
                            </optgroup>
                            <optgroup label="ロード">
                                <option value="10km">10km</option>
                                <option value="ハーフマラソン">ハーフマラソン</option>
                                <option value="マラソン">マラソン</option>
                            </optgroup>
                            <optgroup label="駅伝区間">
                                <option value="1区">1区</option>
                                <option value="2区">2区</option>
                                <option value="3区">3区</option>
                                <option value="4区">4区</option>
                                <option value="5区">5区</option>
                                <option value="6区">6区</option>
                                <option value="7区">7区</option>
                            </optgroup>
                            <optgroup label="その他">
                                <option value="練習">練習</option>
                                <option value="タイムトライアル">タイムトライアル</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- タイム -->
                    <div class="mb-3">
                        <label for="time" class="form-label">タイム <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="time" name="time"
                                   placeholder="例: 15:30 または 930（秒数）" required>
                            <span class="input-group-text"><i class="bi bi-clock"></i></span>
                        </div>
                        <div class="form-text">MM:SS、HH:MM:SS、または秒数で入力可能</div>
                    </div>

                    <!-- メモ -->
                    <div class="mb-4">
                        <label for="memo" class="form-label">メモ</label>
                        <textarea class="form-control" id="memo" name="memo" rows="3"
                                  placeholder="天候、コンディション、コースなど"></textarea>
                    </div>

                    <!-- 送信ボタン -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle"></i> 登録する
                        </button>
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> 戻る
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// タイム入力の自動フォーマット
document.getElementById('time').addEventListener('blur', function() {
    let value = this.value.trim();

    // 数字のみ（秒数）の場合、MM:SS形式に変換
    if (/^\d+$/.test(value)) {
        const totalSeconds = parseInt(value);
        if (totalSeconds >= 3600) {
            // 1時間以上の場合 HH:MM:SS
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            this.value = `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        } else {
            // 1時間未満の場合 MM:SS
            const m = Math.floor(totalSeconds / 60);
            const s = totalSeconds % 60;
            this.value = `${m}:${s.toString().padStart(2, '0')}`;
        }
    }
});
</script>
{% endblock %}
