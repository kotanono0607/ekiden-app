{% extends "base.html" %}

{% block title %}記録登録 - 駅伝アプリ{% endblock %}

{% block extra_css %}
<style>
    .form-header {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        padding: 20px 16px;
        margin: -1rem -12px 0 -12px;
        text-align: center;
    }
    .form-header h5 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
    }
    .form-section {
        background: var(--card-bg);
        border-radius: 12px;
        margin: 16px 0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    .section-title {
        padding: 12px 16px;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-muted);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .section-body {
        padding: 16px;
    }
    .form-label {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-muted);
        margin-bottom: 6px;
    }
    .form-control, .form-select {
        font-size: 16px;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-color);
        color: var(--text-color);
    }
    .form-control:focus, .form-select:focus {
        border-color: #48bb78;
        box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.15);
    }
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        color: var(--text-muted);
        text-decoration: none;
        font-size: 14px;
        padding: 8px 0;
    }
    .submit-area {
        position: sticky;
        bottom: 0;
        background: var(--card-bg);
        padding: 16px;
        margin: 16px -12px -1rem -12px;
        border-top: 1px solid var(--border-color);
    }
    .submit-btn {
        width: 100%;
        padding: 14px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 8px;
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        border: none;
    }

    /* 大会タイプ選択 */
    .type-selector {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
    }
    .type-btn {
        padding: 14px 8px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        background: var(--card-bg);
        font-size: 14px;
        font-weight: 600;
        color: var(--text-muted);
        text-align: center;
        cursor: pointer;
        transition: all 0.15s;
    }
    .type-btn i {
        display: block;
        font-size: 24px;
        margin-bottom: 6px;
    }
    .type-btn:hover {
        border-color: #48bb78;
    }
    .type-btn.selected {
        border-color: #48bb78;
        background: rgba(72, 187, 120, 0.1);
        color: #38a169;
    }
    .type-btn.ekiden.selected {
        border-color: #ED8936;
        background: rgba(237, 137, 54, 0.1);
        color: #DD6B20;
    }
    .type-btn.track.selected {
        border-color: #3182CE;
        background: rgba(49, 130, 206, 0.1);
        color: #2B6CB0;
    }
    .type-btn.road.selected {
        border-color: #38A169;
        background: rgba(56, 161, 105, 0.1);
        color: #2F855A;
    }

    /* 種目グリッド */
    .event-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
    }
    .event-btn {
        padding: 10px 6px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--card-bg);
        font-size: 13px;
        font-weight: 500;
        color: var(--text-color);
        text-align: center;
        cursor: pointer;
        transition: all 0.15s;
    }
    .event-btn:hover {
        border-color: #48bb78;
        color: #48bb78;
    }
    .event-btn.selected {
        border-color: #48bb78;
        background: rgba(72, 187, 120, 0.1);
        color: #38a169;
    }

    /* 区間グリッド */
    .section-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 6px;
    }
    .section-btn {
        padding: 10px 4px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--card-bg);
        font-size: 12px;
        font-weight: 500;
        color: var(--text-color);
        text-align: center;
        cursor: pointer;
        transition: all 0.15s;
    }
    .section-btn:hover {
        border-color: #ED8936;
    }
    .section-btn.selected {
        border-color: #ED8936;
        background: rgba(237, 137, 54, 0.1);
        color: #DD6B20;
    }

    /* 入力グループ */
    .input-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .input-row.three-col {
        grid-template-columns: 1fr 1fr 1fr;
    }

    /* 条件表示 */
    .conditional-section {
        display: none;
    }
    .conditional-section.active {
        display: block;
    }

    /* タイム入力 */
    .time-input {
        text-align: center;
        font-size: 24px;
        font-weight: 600;
        font-family: 'SF Mono', 'Consolas', monospace;
        padding: 16px 12px;
    }

    @media (min-width: 768px) {
        .submit-area {
            position: static;
            margin: 16px 0;
            padding: 0;
            background: transparent;
            border: none;
        }
        .submit-btn {
            width: auto;
            padding: 14px 40px;
        }
    }
</style>
{% endblock %}

{% block content %}
<a href="/" class="back-link">
    <i class="bi bi-chevron-left"></i> 選手一覧
</a>

<div class="form-header">
    <h5><i class="bi bi-stopwatch"></i> 記録登録</h5>
</div>

<form action="/record/add" method="POST" id="recordForm">
    <!-- 選手選択 -->
    <div class="form-section">
        <div class="section-title">
            <i class="bi bi-person text-primary"></i> 選手
        </div>
        <div class="section-body">
            <select class="form-select" id="player_id" name="player_id" required>
                <option value="">選手を選択してください</option>
                {% for player in players %}
                <option value="{{ player.id }}" {% if selected_player_id == player.id|string %}selected{% endif %}>
                    {{ player.name }}{% if player.affiliation %} ({{ player.affiliation }}){% endif %}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- 大会タイプ -->
    <div class="form-section">
        <div class="section-title">
            <i class="bi bi-tag text-info"></i> 大会タイプ
        </div>
        <div class="section-body">
            <input type="hidden" id="race_type" name="race_type" value="">
            <div class="type-selector">
                <button type="button" class="type-btn ekiden" data-type="駅伝">
                    <i class="bi bi-arrow-repeat"></i>
                    駅伝
                </button>
                <button type="button" class="type-btn track" data-type="トラック">
                    <i class="bi bi-circle"></i>
                    トラック
                </button>
                <button type="button" class="type-btn road" data-type="ロード">
                    <i class="bi bi-signpost-2"></i>
                    ロード
                </button>
            </div>
        </div>
    </div>

    <!-- 大会名 -->
    <div class="form-section">
        <div class="section-title">
            <i class="bi bi-trophy text-warning"></i> 大会名
        </div>
        <div class="section-body">
            <input type="text" class="form-control" id="race_name" name="race_name"
                   placeholder="例: 第68回山形県縦断駅伝" list="race_suggestions">
            <datalist id="race_suggestions">
                <option value="第68回山形県縦断駅伝">
                <option value="第67回山形県縦断駅伝">
                <option value="第66回山形県縦断駅伝">
                <option value="山形県高校駅伝">
                <option value="東北高校駅伝">
                <option value="全国高校駅伝">
                <option value="山形県選手権">
                <option value="東北選手権">
                <option value="インターハイ">
            </datalist>
        </div>
    </div>

    <!-- 日付 -->
    <div class="form-section">
        <div class="section-title">
            <i class="bi bi-calendar3 text-info"></i> 日付
        </div>
        <div class="section-body">
            <input type="date" class="form-control" id="date" name="date" value="{{ today }}" required>
        </div>
    </div>

    <!-- 駅伝用：区間選択 -->
    <div class="form-section conditional-section" id="ekiden-section">
        <div class="section-title">
            <i class="bi bi-signpost text-warning"></i> 区間
        </div>
        <div class="section-body">
            <input type="hidden" id="section" name="section" value="">
            <div class="section-grid">
                {% for i in range(1, 30) %}
                <button type="button" class="section-btn" data-section="{{ i }}区">{{ i }}区</button>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- トラック用：種目選択 -->
    <div class="form-section conditional-section" id="track-section">
        <div class="section-title">
            <i class="bi bi-flag text-primary"></i> 種目
        </div>
        <div class="section-body">
            <input type="hidden" id="event_track" name="event_track" value="">
            <div class="event-grid">
                <button type="button" class="event-btn track-event" data-event="800m">800m</button>
                <button type="button" class="event-btn track-event" data-event="1500m">1500m</button>
                <button type="button" class="event-btn track-event" data-event="3000m">3000m</button>
                <button type="button" class="event-btn track-event" data-event="5000m">5000m</button>
                <button type="button" class="event-btn track-event" data-event="10000m">10000m</button>
                <button type="button" class="event-btn track-event" data-event="3000mSC">3000mSC</button>
            </div>
        </div>
    </div>

    <!-- ロード用：種目選択 -->
    <div class="form-section conditional-section" id="road-section">
        <div class="section-title">
            <i class="bi bi-signpost-2 text-success"></i> 種目
        </div>
        <div class="section-body">
            <input type="hidden" id="event_road" name="event_road" value="">
            <div class="event-grid">
                <button type="button" class="event-btn road-event" data-event="5km">5km</button>
                <button type="button" class="event-btn road-event" data-event="10km">10km</button>
                <button type="button" class="event-btn road-event" data-event="ハーフ">ハーフ</button>
                <button type="button" class="event-btn road-event" data-event="フル">フル</button>
            </div>
        </div>
    </div>

    <!-- 統合された event フィールド -->
    <input type="hidden" id="event" name="event" value="">

    <!-- 距離・順位 -->
    <div class="form-section conditional-section" id="detail-section">
        <div class="section-title">
            <i class="bi bi-info-circle text-secondary"></i> 詳細情報
        </div>
        <div class="section-body">
            <div class="input-row">
                <div>
                    <label class="form-label">距離 (km)</label>
                    <input type="number" class="form-control" id="distance_km" name="distance_km"
                           placeholder="10.5" step="0.1" min="0">
                </div>
                <div>
                    <label class="form-label" id="rank-label">順位</label>
                    <input type="number" class="form-control" id="rank_in_section" name="rank_in_section"
                           placeholder="3" min="1">
                </div>
            </div>
        </div>
    </div>

    <!-- タイム -->
    <div class="form-section">
        <div class="section-title">
            <i class="bi bi-clock text-success"></i> タイム
        </div>
        <div class="section-body">
            <input type="text" class="form-control time-input" id="time" name="time"
                   placeholder="15:30 または 1:05:30" required>
            <div class="form-text text-center mt-2">MM:SS または HH:MM:SS 形式で入力</div>
        </div>
    </div>

    <!-- メモ -->
    <div class="form-section">
        <div class="section-title">
            <i class="bi bi-chat-text text-secondary"></i> メモ
        </div>
        <div class="section-body">
            <textarea class="form-control" id="memo" name="memo" rows="2"
                      placeholder="天候、コンディション、コースなど"></textarea>
        </div>
    </div>

    <!-- 送信ボタン -->
    <div class="submit-area">
        <button type="submit" class="btn btn-success submit-btn">
            <i class="bi bi-check-lg"></i> 登録する
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// 大会タイプ選択
document.querySelectorAll('.type-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        const type = this.dataset.type;
        document.getElementById('race_type').value = type;

        // 条件表示の切り替え
        document.querySelectorAll('.conditional-section').forEach(s => s.classList.remove('active'));

        if (type === '駅伝') {
            document.getElementById('ekiden-section').classList.add('active');
            document.getElementById('detail-section').classList.add('active');
            document.getElementById('rank-label').textContent = '区間順位';
        } else if (type === 'トラック') {
            document.getElementById('track-section').classList.add('active');
            document.getElementById('detail-section').classList.add('active');
            document.getElementById('rank-label').textContent = '順位';
        } else if (type === 'ロード') {
            document.getElementById('road-section').classList.add('active');
            document.getElementById('detail-section').classList.add('active');
            document.getElementById('rank-label').textContent = '順位';
        }
    });
});

// 駅伝区間選択
document.querySelectorAll('.section-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.section-btn').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        document.getElementById('section').value = this.dataset.section;
        document.getElementById('event').value = this.dataset.section;
    });
});

// トラック種目選択
document.querySelectorAll('.track-event').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.track-event').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        document.getElementById('event_track').value = this.dataset.event;
        document.getElementById('event').value = this.dataset.event;
    });
});

// ロード種目選択
document.querySelectorAll('.road-event').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.road-event').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        document.getElementById('event_road').value = this.dataset.event;
        document.getElementById('event').value = this.dataset.event;
    });
});

// タイム入力の自動フォーマット
document.getElementById('time').addEventListener('blur', function() {
    let value = this.value.trim();

    // 数字のみ（秒数）の場合、MM:SS形式に変換
    if (/^\d+$/.test(value)) {
        const totalSeconds = parseInt(value);
        if (totalSeconds >= 3600) {
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            this.value = `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        } else {
            const m = Math.floor(totalSeconds / 60);
            const s = totalSeconds % 60;
            this.value = `${m}:${s.toString().padStart(2, '0')}`;
        }
    }
});

// フォーム送信前のバリデーション
document.getElementById('recordForm').addEventListener('submit', function(e) {
    const raceType = document.getElementById('race_type').value;
    const event = document.getElementById('event').value;

    if (!raceType) {
        e.preventDefault();
        alert('大会タイプを選択してください');
        return;
    }

    if (!event) {
        e.preventDefault();
        if (raceType === '駅伝') {
            alert('区間を選択してください');
        } else {
            alert('種目を選択してください');
        }
        return;
    }
});
</script>
{% endblock %}
