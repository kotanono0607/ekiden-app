{% extends "base.html" %}

{% block title %}予定 - 南陽東置賜{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        padding: 24px 16px;
        margin: -1rem -12px 16px -12px;
        text-align: center;
    }
    .page-header h4 {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
    }

    /* 月ナビゲーション */
    .month-nav {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-top: 12px;
    }
    .month-nav-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        text-decoration: none;
        transition: all 0.15s;
    }
    .month-nav-btn:hover {
        background: rgba(255,255,255,0.3);
        color: white;
    }
    .month-title {
        font-size: 18px;
        font-weight: 600;
    }

    /* クイックアクション */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-bottom: 20px;
    }
    .quick-action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 14px 8px;
        background: white;
        border-radius: 12px;
        text-decoration: none;
        color: #2d3748;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        transition: all 0.15s;
    }
    .quick-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        color: #2d3748;
    }
    [data-theme="dark"] .quick-action-btn {
        background: var(--card-bg);
        color: var(--text-color);
    }
    .quick-action-btn i {
        font-size: 22px;
        margin-bottom: 6px;
    }
    .quick-action-btn.primary i { color: #3b82f6; }
    .quick-action-btn.success i { color: #10b981; }
    .quick-action-btn.info i { color: #06b6d4; }
    .quick-action-btn.secondary i { color: #6b7280; }
    .quick-action-btn span {
        font-size: 11px;
        font-weight: 500;
        text-align: center;
    }

    /* カレンダーカード */
    .calendar-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    [data-theme="dark"] .calendar-card {
        background: var(--card-bg);
    }

    /* カレンダーグリッド */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
    }
    .calendar-day-header {
        padding: 12px 4px;
        text-align: center;
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        border-bottom: 1px solid var(--border-color);
    }
    .calendar-day-header.sun { color: #ef4444; }
    .calendar-day-header.sat { color: #3b82f6; }

    .calendar-day {
        min-height: 72px;
        padding: 6px;
        border-right: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: background 0.15s;
        position: relative;
    }
    .calendar-day:nth-child(7n) {
        border-right: none;
    }
    .calendar-day:hover {
        background: rgba(59, 130, 246, 0.05);
    }
    .calendar-day.empty {
        background: #f8fafc;
        cursor: default;
    }
    [data-theme="dark"] .calendar-day.empty {
        background: rgba(0,0,0,0.2);
    }
    .calendar-day.today {
        background: rgba(59, 130, 246, 0.1);
    }
    .calendar-day.today .day-number {
        background: #3b82f6;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .day-number {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 4px;
    }
    .calendar-day.sun .day-number { color: #ef4444; }
    .calendar-day.sat .day-number { color: #3b82f6; }
    .calendar-day.today .day-number { color: white; }

    /* イベントドット */
    .day-events {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }
    .day-event {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: white;
        font-weight: 500;
    }
    .day-event.practice { background: linear-gradient(135deg, #10b981, #059669); }
    .day-event.race { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .day-event.camp { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .day-event.rest { background: linear-gradient(135deg, #6b7280, #4b5563); }
    .day-event.other { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

    .day-log {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
    }
    .day-log i {
        font-size: 9px;
    }

    .day-more {
        font-size: 9px;
        color: #64748b;
        text-align: center;
        margin-top: 2px;
    }

    /* 凡例 */
    .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        padding: 12px 16px;
        border-top: 1px solid var(--border-color);
        background: #f8fafc;
    }
    [data-theme="dark"] .legend {
        background: rgba(0,0,0,0.2);
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        color: #64748b;
    }
    .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 3px;
    }
    .legend-dot.practice { background: #10b981; }
    .legend-dot.race { background: #ef4444; }
    .legend-dot.camp { background: #f59e0b; }
    .legend-dot.rest { background: #6b7280; }
    .legend-dot.log { background: #3b82f6; }

    /* モーダル */
    .modal-content {
        border-radius: 16px;
        border: none;
    }
    .modal-header {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        border-radius: 16px 16px 0 0;
        border: none;
    }
    .modal-header .btn-close {
        filter: brightness(0) invert(1);
    }
    .event-list-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: #f8fafc;
        border-radius: 10px;
        margin-bottom: 8px;
    }
    [data-theme="dark"] .event-list-item {
        background: rgba(255,255,255,0.05);
    }
    .event-list-title {
        font-weight: 500;
        color: var(--text-color);
    }
    .event-type-badge {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 10px;
        color: white;
        margin-left: 8px;
    }
    .modal-actions {
        display: grid;
        gap: 10px;
    }
    .modal-action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 14px;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.15s;
    }
    .modal-action-btn.primary {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
    }
    .modal-action-btn.success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }
    .modal-action-btn.info {
        background: linear-gradient(135deg, #06b6d4, #0891b2);
        color: white;
    }
    .modal-action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        color: white;
    }

    /* メニュープレビュー */
    .menu-preview {
        background: #f8fafc;
        border-radius: 10px;
        padding: 12px;
        margin-top: 8px;
    }
    [data-theme="dark"] .menu-preview {
        background: rgba(255,255,255,0.05);
    }
    .menu-preview-title {
        font-size: 11px;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .menu-preview-item {
        background: white;
        border-radius: 6px;
        padding: 8px 10px;
        margin-bottom: 6px;
        border-left: 3px solid #667eea;
    }
    [data-theme="dark"] .menu-preview-item {
        background: rgba(255,255,255,0.08);
    }
    .menu-preview-item:last-child {
        margin-bottom: 0;
    }
    .menu-preview-type {
        font-size: 10px;
        color: #667eea;
        font-weight: 600;
    }
    .menu-preview-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-color);
    }
    .menu-preview-detail {
        font-size: 11px;
        color: #64748b;
        margin-top: 2px;
    }
    .menu-preview-group {
        font-size: 10px;
        color: #f59e0b;
        margin-top: 2px;
    }
    .menu-preview-empty {
        font-size: 12px;
        color: #94a3b8;
        text-align: center;
        padding: 8px;
    }

    @media (max-width: 768px) {
        .calendar-day {
            min-height: 56px;
            padding: 4px;
        }
        .day-number {
            font-size: 12px;
        }
        .day-event, .day-log {
            font-size: 8px;
            padding: 1px 4px;
        }
        .calendar-day.today .day-number {
            width: 24px;
            height: 24px;
            font-size: 11px;
        }
        .quick-actions {
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        .quick-action-btn {
            padding: 10px 4px;
        }
        .quick-action-btn i {
            font-size: 18px;
        }
        .quick-action-btn span {
            font-size: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h4><i class="bi bi-calendar3"></i> 予定</h4>
    <div class="month-nav">
        <a href="{{ url_for('calendar_view', year=prev_year, month=prev_month) }}" class="month-nav-btn">
            <i class="bi bi-chevron-left"></i>
        </a>
        <span class="month-title">{{ year }}年{{ month }}月</span>
        <a href="{{ url_for('calendar_view', year=next_year, month=next_month) }}" class="month-nav-btn">
            <i class="bi bi-chevron-right"></i>
        </a>
    </div>
</div>

<!-- クイックアクション -->
<div class="quick-actions">
    <a href="{{ url_for('event_add') }}" class="quick-action-btn primary">
        <i class="bi bi-plus-circle"></i>
        <span>予定追加</span>
    </a>
    <a href="{{ url_for('practice_log_add') }}" class="quick-action-btn success">
        <i class="bi bi-journal-plus"></i>
        <span>練習日誌</span>
    </a>
    <a href="{{ url_for('attendance') }}" class="quick-action-btn info">
        <i class="bi bi-person-check"></i>
        <span>出欠入力</span>
    </a>
    <a href="{{ url_for('practice_logs') }}" class="quick-action-btn secondary">
        <i class="bi bi-journal-text"></i>
        <span>日誌一覧</span>
    </a>
</div>

<!-- カレンダー -->
<div class="calendar-card">
    <div class="calendar-grid">
        <div class="calendar-day-header sun">日</div>
        <div class="calendar-day-header">月</div>
        <div class="calendar-day-header">火</div>
        <div class="calendar-day-header">水</div>
        <div class="calendar-day-header">木</div>
        <div class="calendar-day-header">金</div>
        <div class="calendar-day-header sat">土</div>

        {% for week in month_days %}
            {% for day in week %}
                {% if day == 0 %}
                    <div class="calendar-day empty"></div>
                {% else %}
                    {% set date_str = '%04d-%02d-%02d'|format(year, month, day) %}
                    {% set is_today = date_str == today %}
                    {% set day_events = events_by_date.get(date_str, []) %}
                    {% set day_log = logs_by_date.get(date_str) %}
                    {% set weekday = loop.index0 %}
                    <div class="calendar-day {% if is_today %}today{% endif %} {% if weekday == 0 %}sun{% elif weekday == 6 %}sat{% endif %}"
                         onclick="openDayMenu('{{ date_str }}')">
                        <div class="day-number">{{ day }}</div>
                        <div class="day-events">
                            {% for event in day_events[:2] %}
                                <div class="day-event {{ event.event_type|lower if event.event_type else 'other' }}" title="{{ event.title }}">
                                    {{ event.title }}
                                </div>
                            {% endfor %}
                            {% if day_log and day_events|length < 2 %}
                                <div class="day-log" title="練習日誌: {{ day_log.title }}">
                                    <i class="bi bi-journal"></i> {{ day_log.title }}
                                </div>
                            {% endif %}
                            {% if day_events|length > 2 or (day_events|length == 2 and day_log) %}
                                <div class="day-more">+{{ day_events|length - 2 + (1 if day_log else 0) }}</div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% endfor %}
    </div>

    <!-- 凡例 -->
    <div class="legend">
        <div class="legend-item"><div class="legend-dot practice"></div>練習</div>
        <div class="legend-item"><div class="legend-dot race"></div>大会</div>
        <div class="legend-item"><div class="legend-dot camp"></div>合宿</div>
        <div class="legend-item"><div class="legend-dot rest"></div>休み</div>
        <div class="legend-item"><div class="legend-dot log"></div>日誌</div>
    </div>
</div>

<!-- Day Menu Modal -->
<div class="modal fade" id="dayMenuModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayMenuDate"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="dayMenuEvents" class="mb-3"></div>
                <div class="modal-actions">
                    <a id="addEventBtn" href="#" class="modal-action-btn primary">
                        <i class="bi bi-plus-circle"></i> 予定を追加
                    </a>
                    <a id="addLogBtn" href="#" class="modal-action-btn success">
                        <i class="bi bi-journal-plus"></i> 練習日誌を作成
                    </a>
                    <a id="attendanceBtn" href="#" class="modal-action-btn info">
                        <i class="bi bi-person-check"></i> 出欠を入力
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const eventsData = {{ events_by_date|tojson|safe }};
const logsData = {{ logs_by_date|tojson|safe }};

const typeColors = {
    'practice': '#10b981',
    'race': '#ef4444',
    'camp': '#f59e0b',
    'rest': '#6b7280',
    'other': '#8b5cf6'
};

// メニュープレビューを生成
function renderMenuPreview(log) {
    if (!log.menu_data) return '';

    let menuData;
    try {
        menuData = typeof log.menu_data === 'string' ? JSON.parse(log.menu_data) : log.menu_data;
    } catch (e) {
        return '';
    }

    if (!menuData.menus || menuData.menus.length === 0) {
        return '';
    }

    let html = '<div class="menu-preview">';
    html += '<div class="menu-preview-title"><i class="bi bi-list-check"></i> 練習メニュー</div>';

    menuData.menus.forEach(menu => {
        const typeLabel = menu.type === 'pace_run' ? 'ペース走' :
                         menu.type === 'interval' ? 'インターバル' : 'TT';

        let detail = '';
        if (menu.type === 'pace_run') {
            if (menu.total) detail = `total ${menu.total}`;
        } else if (menu.type === 'interval') {
            if (menu.pace) detail = `設定 ${menu.pace}`;
            if (menu.rest) detail += detail ? ` / ${menu.rest}` : menu.rest;
        } else if (menu.type === 'tt') {
            if (menu.results && menu.results.length > 0) {
                detail = `${menu.results.length}名参加`;
            }
        }

        let groupInfo = '';
        if (menu.group) {
            groupInfo = `${menu.group}グループ`;
            if (menu.members && menu.members.length > 0) {
                groupInfo += ': ' + menu.members.map(m => m.name).slice(0, 3).join(', ');
                if (menu.members.length > 3) groupInfo += '...';
            }
        }

        html += `<div class="menu-preview-item">
            <div class="menu-preview-type">${typeLabel}</div>
            <div class="menu-preview-name">${menu.name}</div>
            ${detail ? `<div class="menu-preview-detail">${detail}</div>` : ''}
            ${groupInfo ? `<div class="menu-preview-group"><i class="bi bi-people-fill"></i> ${groupInfo}</div>` : ''}
        </div>`;
    });

    html += '</div>';
    return html;
}

function openDayMenu(dateStr) {
    const modal = new bootstrap.Modal(document.getElementById('dayMenuModal'));
    const date = new Date(dateStr);
    const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
    const dateLabel = `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日(${weekdays[date.getDay()]})`;

    document.getElementById('dayMenuDate').textContent = dateLabel;
    document.getElementById('addEventBtn').href = `/event/add?date=${dateStr}`;
    document.getElementById('addLogBtn').href = `/practice_log/add?date=${dateStr}`;
    document.getElementById('attendanceBtn').href = `/attendance?date=${dateStr}`;

    const eventsDiv = document.getElementById('dayMenuEvents');
    const events = eventsData[dateStr] || [];
    const log = logsData[dateStr];

    let html = '';
    if (events.length > 0) {
        events.forEach(e => {
            const typeColor = typeColors[e.event_type?.toLowerCase()] || typeColors.other;
            html += `<div class="event-list-item">
                <div>
                    <span class="event-list-title">${e.title}</span>
                    <span class="event-type-badge" style="background: ${typeColor}">${e.event_type || 'その他'}</span>
                </div>
                <a href="/event/${e.event_id}/edit" class="btn btn-sm btn-outline-secondary">編集</a>
            </div>`;
        });
    }
    if (log) {
        html += `<div class="event-list-item">
            <div>
                <span class="event-list-title">${log.title}</span>
                <span class="event-type-badge" style="background: #3b82f6">練習日誌</span>
            </div>
            <a href="/practice_log/${log.log_id}" class="btn btn-sm btn-outline-primary">詳細</a>
        </div>`;

        // メニュープレビューを追加
        html += renderMenuPreview(log);
    }
    if (!events.length && !log) {
        html = '<p class="text-muted text-center mb-0">この日の予定はありません</p>';
    }
    eventsDiv.innerHTML = html;

    modal.show();
}
</script>
{% endblock %}
