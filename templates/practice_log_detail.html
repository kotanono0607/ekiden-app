{% extends "base.html" %}

{% block title %}{{ log.title }} - 練習日誌 - 南陽東置賜{% endblock %}

{% block extra_css %}
<style>
    .log-header {
        background: var(--primary-gradient);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 16px;
    }
    .log-date {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 4px;
    }
    .log-title {
        font-size: 20px;
        font-weight: 700;
    }
    .info-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 16px;
    }
    .info-item {
        background: var(--card-bg);
        padding: 12px;
        border-radius: 8px;
        text-align: center;
    }
    .info-icon {
        font-size: 20px;
        color: #667eea;
        margin-bottom: 4px;
    }
    .info-label {
        font-size: 11px;
        color: var(--text-muted);
    }
    .info-value {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-color);
    }
    .content-section {
        background: var(--card-bg);
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
    }
    .content-section h6 {
        color: var(--text-muted);
        font-size: 12px;
        margin-bottom: 8px;
    }
    .content-text {
        white-space: pre-wrap;
        color: var(--text-color);
    }
    /* Attendance input styles */
    .attendance-section {
        background: var(--card-bg);
        padding: 16px;
        border-radius: 12px;
    }
    .attendance-section h6 {
        color: var(--text-muted);
        font-size: 12px;
        margin-bottom: 12px;
    }
    .player-row {
        display: flex;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid var(--border-color);
        gap: 8px;
    }
    .player-row:last-child {
        border-bottom: none;
    }
    .player-category {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        background: #e2e8f0;
        color: #475569;
        white-space: nowrap;
        min-width: 32px;
        text-align: center;
    }
    [data-theme="dark"] .player-category {
        background: rgba(255,255,255,0.1);
        color: #94a3b8;
    }
    .player-name {
        flex: 1;
        font-size: 14px;
        color: var(--text-color);
    }
    .status-btns {
        display: flex;
        gap: 4px;
    }
    .status-btn {
        padding: 2px 10px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        background: transparent;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.15s;
        color: var(--text-muted);
    }
    .status-btn:hover {
        border-color: #667eea;
    }
    .status-btn.active {
        background: #667eea;
        border-color: #667eea;
        color: white;
    }
    .status-btn.present.active { background: #10b981; border-color: #10b981; }
    .status-btn.absent.active { background: #ef4444; border-color: #ef4444; }
    .status-btn.clear { color: var(--text-muted); }
    .summary-inline {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
        font-size: 13px;
    }
    .summary-inline span { color: var(--text-muted); }
    .summary-inline .count { font-weight: 600; }
    .summary-inline .present { color: #10b981; }
    .summary-inline .absent { color: #ef4444; }
    /* Guest section */
    .guest-section {
        border-top: 1px dashed var(--border-color);
        margin-top: 8px;
        padding-top: 8px;
    }
    .guest-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 12px;
        color: var(--text-muted);
    }
    .guest-row {
        display: flex;
        align-items: center;
        padding: 6px 0;
        gap: 8px;
    }
    .guest-name-input {
        flex: 1;
        font-size: 12px;
        padding: 3px 8px;
        max-width: 120px;
    }
    .btn-add-guest {
        font-size: 11px;
        padding: 2px 6px;
    }
    .btn-remove-guest {
        padding: 2px 5px;
        font-size: 10px;
    }
    /* Menu display styles */
    .menu-section {
        background: var(--card-bg);
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
    }
    .menu-section h6 {
        color: var(--text-muted);
        font-size: 12px;
        margin-bottom: 12px;
    }
    .menu-item {
        background: rgba(102, 126, 234, 0.08);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
    }
    .menu-item:last-child {
        margin-bottom: 0;
    }
    .menu-type-badge {
        display: inline-block;
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 10px;
        background: #667eea;
        color: white;
        margin-bottom: 6px;
    }
    .menu-type-badge.interval { background: #f59e0b; }
    .menu-type-badge.tt { background: #10b981; }
    .menu-name {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 8px;
    }
    .menu-detail {
        font-size: 13px;
        color: var(--text-muted);
    }
    .lap-table {
        width: 100%;
        font-size: 12px;
        margin-top: 8px;
    }
    .lap-table th, .lap-table td {
        padding: 4px 8px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
    }
    .lap-table th {
        color: var(--text-muted);
        font-weight: 500;
    }
    .lap-table td {
        color: var(--text-color);
    }
    .lap-table tr:last-child td {
        border-bottom: none;
    }
    .total-row {
        font-weight: 600;
        background: rgba(102, 126, 234, 0.1);
    }
    .result-list {
        margin-top: 8px;
    }
    .result-item {
        display: flex;
        align-items: center;
        padding: 4px 0;
        font-size: 13px;
        gap: 8px;
    }
    .result-rank {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 12px;
        color: var(--text-color);
    }
    .result-rank.gold { background: #fbbf24; color: #78350f; }
    .result-rank.silver { background: #d1d5db; color: #374151; }
    .result-rank.bronze { background: #d97706; color: white; }
    .result-player {
        flex: 1;
        color: var(--text-color);
    }
    .result-time {
        font-weight: 500;
        color: #667eea;
    }
    .menu-group-info {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 8px;
        padding: 6px 10px;
        background: rgba(245, 158, 11, 0.1);
        border-radius: 6px;
        font-size: 12px;
    }
    .menu-group-badge {
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 11px;
        color: white;
    }
    .menu-group-badge.group-a { background: #3b82f6; }
    .menu-group-badge.group-b { background: #10b981; }
    .menu-group-badge.group-c { background: #f59e0b; }
    .menu-group-members {
        color: var(--text-muted);
        font-size: 11px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <a href="{{ url_for('practice_logs') }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> 一覧
    </a>
    <a href="{{ url_for('practice_log_edit', log_id=log.log_id) }}" class="btn btn-primary btn-sm">
        <i class="bi bi-pencil"></i> 編集
    </a>
</div>

<div class="log-header">
    <div class="log-date">{{ log.date }}</div>
    <div class="log-title">{{ log.title }}</div>
</div>

<div class="info-grid">
    <div class="info-item">
        <div class="info-icon"><i class="bi bi-cloud-sun"></i></div>
        <div class="info-label">天候</div>
        <div class="info-value">{{ log.weather or '-' }}</div>
    </div>
    <div class="info-item">
        <div class="info-icon"><i class="bi bi-thermometer-half"></i></div>
        <div class="info-label">気温</div>
        <div class="info-value">{{ log.temperature + '℃' if log.temperature else '-' }}</div>
    </div>
    <div class="info-item">
        <div class="info-icon"><i class="bi bi-people"></i></div>
        <div class="info-label">参加</div>
        <div class="info-value" id="participantCount">{{ log.participants + '名' if log.participants else '-' }}</div>
    </div>
</div>

{% if log.memo %}
<div class="content-section">
    <h6><i class="bi bi-sticky"></i> メモ</h6>
    <div class="content-text">{{ log.memo }}</div>
</div>
{% endif %}

<!-- 練習メニュー表示セクション -->
<div class="menu-section" id="menuSection">
    <h6><i class="bi bi-list-check"></i> 練習メニュー</h6>
    <div id="menuDisplay">
        <div class="text-center py-3">
            <p class="text-muted mb-2">メニューが登録されていません</p>
            <a href="{{ url_for('practice_log_edit', log_id=log.log_id) }}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-plus-lg"></i> メニューを追加
            </a>
        </div>
    </div>
</div>

<!-- 出欠入力セクション -->
<div class="attendance-section">
    <h6><i class="bi bi-person-check"></i> 出欠入力</h6>
    <div class="summary-inline">
        <span>出席 <span class="count present" id="presentCount">0</span></span>
        <span>欠席 <span class="count absent" id="absentCount">0</span></span>
        <button type="button" class="btn btn-outline-secondary btn-sm ms-auto" onclick="copyAttendees()" id="copyBtn">
            <i class="bi bi-clipboard"></i> コピー
        </button>
    </div>
    <form method="POST" action="{{ url_for('attendance_save') }}" id="attendanceForm">
        <input type="hidden" name="date" value="{{ log.date }}">
        <input type="hidden" name="redirect_to" value="{{ url_for('practice_log_detail', log_id=log.log_id) }}">

        {% for player in players %}
        {% set att = attendance_by_player.get(player.id|string, {}) %}
        <div class="player-row">
            {% if player.category %}<span class="player-category">{{ player.category }}</span>{% endif %}
            <div class="player-name">{{ player.name }}</div>
            <div class="status-btns">
                <button type="button" class="status-btn present {% if att.status == '出席' %}active{% endif %}"
                        onclick="selectStatus(this, '{{ player.id }}', '出席')">出席</button>
                <button type="button" class="status-btn absent {% if att.status == '欠席' %}active{% endif %}"
                        onclick="selectStatus(this, '{{ player.id }}', '欠席')">欠席</button>
                <button type="button" class="status-btn clear {% if not att.status %}active{% endif %}"
                        onclick="selectStatus(this, '{{ player.id }}', '')">クリア</button>
            </div>
            <input type="hidden" name="status_{{ player.id }}" id="status_{{ player.id }}" value="{{ att.status or '' }}">
        </div>
        {% else %}
        <div class="text-center py-3 text-muted">
            選手が登録されていません
        </div>
        {% endfor %}

        <!-- ゲストセクション -->
        <div class="guest-section">
            <div class="guest-header">
                <span><i class="bi bi-person-plus"></i> ゲスト</span>
                <button type="button" class="btn btn-outline-primary btn-add-guest" onclick="addGuest()">
                    <i class="bi bi-plus"></i> 追加
                </button>
            </div>
            <div id="guestList">
                {% for guest in guests %}
                <div class="guest-row" data-guest-index="{{ loop.index0 }}">
                    <input type="text" class="form-control form-control-sm guest-name-input"
                           name="guest_name_{{ loop.index0 }}" value="{{ guest.name }}" placeholder="名前">
                    <div class="status-btns">
                        <button type="button" class="status-btn present {% if guest.status == '出席' %}active{% endif %}"
                                onclick="selectGuestStatus(this, {{ loop.index0 }}, '出席')">出席</button>
                        <button type="button" class="status-btn absent {% if guest.status == '欠席' %}active{% endif %}"
                                onclick="selectGuestStatus(this, {{ loop.index0 }}, '欠席')">欠席</button>
                        <button type="button" class="status-btn clear {% if not guest.status %}active{% endif %}"
                                onclick="selectGuestStatus(this, {{ loop.index0 }}, '')">クリア</button>
                    </div>
                    <input type="hidden" name="guest_status_{{ loop.index0 }}" id="guest_status_{{ loop.index0 }}" value="{{ guest.status or '出席' }}">
                    <button type="button" class="btn btn-outline-danger btn-remove-guest" onclick="removeGuest(this)">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        <input type="hidden" name="guest_count" id="guestCount" value="{{ guests|length }}">

        <div class="d-grid mt-3">
            <button type="submit" class="btn btn-success btn-sm">
                <i class="bi bi-check-lg"></i> 出欠を保存
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
let guestIndex = {{ guests|length }};

function selectStatus(btn, playerId, status) {
    btn.parentElement.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('status_' + playerId).value = status;
    updateSummary();
}

function selectGuestStatus(btn, index, status) {
    btn.parentElement.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('guest_status_' + index).value = status;
    updateSummary();
}

function updateSummary() {
    let present = 0, absent = 0;
    document.querySelectorAll('input[id^="status_"]:not([id^="guest_status_"])').forEach(input => {
        if (input.value === '出席') present++;
        else if (input.value === '欠席') absent++;
    });
    document.querySelectorAll('.guest-row').forEach(row => {
        const nameInput = row.querySelector('.guest-name-input');
        const statusInput = row.querySelector('input[id^="guest_status_"]');
        if (nameInput && nameInput.value.trim() && statusInput) {
            if (statusInput.value === '出席') present++;
            else if (statusInput.value === '欠席') absent++;
        }
    });
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = absent;
    // Update participant count in info grid
    const total = present;
    document.getElementById('participantCount').textContent = total > 0 ? total + '名' : '-';
}

function addGuest() {
    const guestList = document.getElementById('guestList');
    const html = `
        <div class="guest-row" data-guest-index="${guestIndex}">
            <input type="text" class="form-control form-control-sm guest-name-input"
                   name="guest_name_${guestIndex}" placeholder="名前">
            <div class="status-btns">
                <button type="button" class="status-btn present active"
                        onclick="selectGuestStatus(this, ${guestIndex}, '出席')">出席</button>
                <button type="button" class="status-btn absent"
                        onclick="selectGuestStatus(this, ${guestIndex}, '欠席')">欠席</button>
                <button type="button" class="status-btn clear"
                        onclick="selectGuestStatus(this, ${guestIndex}, '')">クリア</button>
            </div>
            <input type="hidden" name="guest_status_${guestIndex}" id="guest_status_${guestIndex}" value="出席">
            <button type="button" class="btn btn-outline-danger btn-remove-guest" onclick="removeGuest(this)">
                <i class="bi bi-x"></i>
            </button>
        </div>
    `;
    guestList.insertAdjacentHTML('beforeend', html);
    guestIndex++;
    document.getElementById('guestCount').value = document.querySelectorAll('.guest-row').length;
    updateSummary();
}

function removeGuest(btn) {
    btn.closest('.guest-row').remove();
    document.getElementById('guestCount').value = document.querySelectorAll('.guest-row').length;
    updateSummary();
}

// Initial summary
updateSummary();

// 出席者をクリップボードにコピー
function copyAttendees() {
    const attendees = [];

    // 選手の出席者を収集
    document.querySelectorAll('.player-row').forEach(row => {
        const statusInput = row.querySelector('input[id^="status_"]');
        if (statusInput && statusInput.value === '出席') {
            const name = row.querySelector('.player-name').textContent.trim();
            const category = row.querySelector('.player-category');
            if (category) {
                attendees.push(`${category.textContent.trim()} ${name}`);
            } else {
                attendees.push(name);
            }
        }
    });

    // ゲストの出席者を収集
    document.querySelectorAll('.guest-row').forEach(row => {
        const nameInput = row.querySelector('.guest-name-input');
        const statusInput = row.querySelector('input[id^="guest_status_"]');
        if (nameInput && nameInput.value.trim() && statusInput && statusInput.value === '出席') {
            attendees.push(`(ゲスト) ${nameInput.value.trim()}`);
        }
    });

    if (attendees.length === 0) {
        alert('出席者がいません');
        return;
    }

    const text = attendees.join('\n');
    navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById('copyBtn');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> コピー完了';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(err => {
        console.error('Copy failed:', err);
        alert('コピーに失敗しました');
    });
}

// Menu data display
const menuDataRaw = {{ log.menu_data | tojson | safe if log.menu_data else 'null' }};
if (menuDataRaw) {
    try {
        const menuData = typeof menuDataRaw === 'string' ? JSON.parse(menuDataRaw) : menuDataRaw;
        if (menuData && menuData.menus && menuData.menus.length > 0) {
            renderMenus(menuData.menus);
        }
    } catch (e) {
        console.error('Menu data parse error:', e);
    }
}

function renderMenus(menus) {
    const container = document.getElementById('menuDisplay');
    let html = '';

    menus.forEach(menu => {
        if (menu.type === 'pace_run') {
            html += renderPaceRun(menu);
        } else if (menu.type === 'interval') {
            html += renderInterval(menu);
        } else if (menu.type === 'tt') {
            html += renderTT(menu);
        }
    });

    container.innerHTML = html;
}

function renderGroupInfo(menu) {
    if (!menu.group) return '';

    let groupClass = 'group-c';
    if (menu.group === 'A') groupClass = 'group-a';
    else if (menu.group === 'B') groupClass = 'group-b';
    else if (menu.group === 'C') groupClass = 'group-c';

    let members = '';
    if (menu.members && menu.members.length > 0) {
        members = menu.members.map(m => m.name).join(', ');
    }

    return `
        <div class="menu-group-info">
            <span class="menu-group-badge ${groupClass}">${escapeHtml(menu.group)}グループ</span>
            ${members ? `<span class="menu-group-members">${escapeHtml(members)}</span>` : ''}
        </div>
    `;
}

function renderPaceRun(menu) {
    let html = `
        <div class="menu-item">
            ${renderGroupInfo(menu)}
            <span class="menu-type-badge">ペース走</span>
            <div class="menu-name">${escapeHtml(menu.name)}</div>
    `;

    if (menu.lap_distance) {
        html += `<div class="menu-detail">周回距離: ${escapeHtml(menu.lap_distance)}</div>`;
    }

    if (menu.laps && menu.laps.length > 0) {
        html += `
            <table class="lap-table">
                <thead>
                    <tr>
                        <th>距離</th>
                        <th>タイム</th>
                    </tr>
                </thead>
                <tbody>
        `;
        menu.laps.forEach(lap => {
            html += `
                <tr>
                    <td>${escapeHtml(lap.distance)}</td>
                    <td>${escapeHtml(lap.time)}</td>
                </tr>
            `;
        });

        if (menu.total) {
            html += `
                <tr class="total-row">
                    <td>Total</td>
                    <td>${escapeHtml(menu.total)}</td>
                </tr>
            `;
        }
        html += '</tbody></table>';
    }

    html += '</div>';
    return html;
}

function renderInterval(menu) {
    let detail = '';
    if (menu.pace) detail += `設定: ${escapeHtml(menu.pace)}`;
    if (menu.rest) detail += (detail ? ' / ' : '') + `レスト: ${escapeHtml(menu.rest)}`;

    let html = `
        <div class="menu-item">
            ${renderGroupInfo(menu)}
            <span class="menu-type-badge interval">インターバル</span>
            <div class="menu-name">${escapeHtml(menu.name)}</div>
            ${detail ? `<div class="menu-detail">${detail}</div>` : ''}
    `;

    if (menu.times && menu.times.length > 0) {
        html += `
            <table class="lap-table">
                <thead>
                    <tr>
                        <th>本数</th>
                        <th>タイム</th>
                    </tr>
                </thead>
                <tbody>
        `;
        menu.times.forEach(t => {
            html += `
                <tr>
                    <td>${t.rep}本目</td>
                    <td>${escapeHtml(t.time)}</td>
                </tr>
            `;
        });
        html += '</tbody></table>';
    }

    html += '</div>';
    return html;
}

function renderTT(menu) {
    let html = `
        <div class="menu-item">
            ${renderGroupInfo(menu)}
            <span class="menu-type-badge tt">TT</span>
            <div class="menu-name">${escapeHtml(menu.name)}</div>
    `;

    if (menu.distance) {
        html += `<div class="menu-detail">距離: ${escapeHtml(menu.distance)}</div>`;
    }

    if (menu.results && menu.results.length > 0) {
        // Sort by rank if available
        const sortedResults = [...menu.results].sort((a, b) => (a.rank || 999) - (b.rank || 999));

        html += '<div class="result-list">';
        sortedResults.forEach((result, idx) => {
            const rank = result.rank || (idx + 1);
            let rankClass = '';
            if (rank === 1) rankClass = 'gold';
            else if (rank === 2) rankClass = 'silver';
            else if (rank === 3) rankClass = 'bronze';

            html += `
                <div class="result-item">
                    <div class="result-rank ${rankClass}">${rank}</div>
                    <div class="result-player">${escapeHtml(result.player)}</div>
                    <div class="result-time">${escapeHtml(result.time)}</div>
                </div>
            `;
        });
        html += '</div>';
    }

    html += '</div>';
    return html;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
