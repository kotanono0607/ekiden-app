{% extends "base.html" %}

{% block title %}出欠入力 - 南陽東置賜{% endblock %}

{% block extra_css %}
<style>
    .date-nav {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-bottom: 12px;
    }
    .date-nav .btn {
        padding: 6px 10px;
    }
    .date-display {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-color);
    }
    .player-row {
        display: flex;
        align-items: center;
        padding: 6px 12px;
        border-bottom: 1px solid var(--border-color);
        gap: 8px;
        min-height: 36px;
    }
    .player-row:last-child {
        border-bottom: none;
    }
    .player-category {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        background: #e2e8f0;
        color: #475569;
        white-space: nowrap;
        min-width: 32px;
        text-align: center;
    }
    [data-theme="dark"] .player-category {
        background: rgba(255,255,255,0.1);
        color: #94a3b8;
    }
    .player-name {
        flex: 1;
        font-weight: 500;
        font-size: 14px;
        color: var(--text-color);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .status-btns {
        display: flex;
        gap: 4px;
    }
    .status-btn {
        padding: 3px 12px;
        border-radius: 14px;
        border: 1px solid var(--border-color);
        background: transparent;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.15s;
        color: var(--text-muted);
    }
    .status-btn:hover {
        border-color: #667eea;
    }
    .status-btn.active {
        background: #667eea;
        border-color: #667eea;
        color: white;
    }
    .status-btn.present.active { background: #10b981; border-color: #10b981; }
    .status-btn.absent.active { background: #ef4444; border-color: #ef4444; }
    .status-btn.clear { color: var(--text-muted); }
    .status-btn.clear:hover { border-color: #9ca3af; }
    .quick-actions {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }
    .summary {
        display: flex;
        gap: 16px;
        justify-content: center;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }
    .summary-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 13px;
    }
    .summary-count {
        font-weight: 600;
        font-size: 16px;
    }
    .summary-item.present .summary-count { color: #10b981; }
    .summary-item.absent .summary-count { color: #ef4444; }

    /* Guest section */
    .guest-section {
        border-top: 2px dashed var(--border-color);
        margin-top: 8px;
        padding-top: 8px;
    }
    .guest-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 4px 12px;
        font-size: 13px;
        color: var(--text-muted);
    }
    .guest-row {
        display: flex;
        align-items: center;
        padding: 6px 12px;
        border-bottom: 1px solid var(--border-color);
        gap: 8px;
    }
    .guest-name-input {
        flex: 1;
        font-size: 13px;
        padding: 4px 8px;
        max-width: 150px;
    }
    .btn-add-guest {
        font-size: 12px;
        padding: 2px 8px;
    }
    .btn-remove-guest {
        padding: 2px 6px;
        font-size: 11px;
    }

    @media (max-width: 576px) {
        .player-row, .guest-row {
            flex-wrap: wrap;
            padding: 8px 12px;
        }
        .player-name {
            width: 100%;
            margin-bottom: 4px;
        }
        .status-btns {
            width: 100%;
            justify-content: flex-start;
        }
        .guest-name-input {
            max-width: none;
            width: 100%;
            margin-bottom: 4px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="mb-0"><i class="bi bi-person-check text-primary"></i> 出欠入力</h5>
    <a href="{{ url_for('calendar_view') }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-calendar3"></i>
    </a>
</div>

<div class="date-nav">
    <a href="#" class="btn btn-outline-secondary btn-sm" id="prevDateBtn">
        <i class="bi bi-chevron-left"></i>
    </a>
    <input type="date" class="form-control form-control-sm" id="dateInput" value="{{ date }}" style="width: auto;">
    <a href="#" class="btn btn-outline-secondary btn-sm" id="nextDateBtn">
        <i class="bi bi-chevron-right"></i>
    </a>
</div>

<div class="summary" id="summary">
    <div class="summary-item present">
        <span>出席</span>
        <span class="summary-count" id="presentCount">0</span>
    </div>
    <div class="summary-item absent">
        <span>欠席</span>
        <span class="summary-count" id="absentCount">0</span>
    </div>
</div>

<div class="quick-actions">
    <button type="button" class="btn btn-success btn-sm" onclick="setAllStatus('出席')">
        <i class="bi bi-check-all"></i> 全員出席
    </button>
    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllStatus()">
        <i class="bi bi-x-lg"></i> クリア
    </button>
</div>

<form method="POST" action="{{ url_for('attendance_save') }}">
    <input type="hidden" name="date" value="{{ date }}">

    <div class="card mb-3">
        {% for player in players %}
        {% set att = attendance_by_player.get(player.id|string, {}) %}
        <div class="player-row">
            {% if player.category %}<span class="player-category">{{ player.category }}</span>{% endif %}
            <div class="player-name">{{ player.name }}</div>
            <div class="status-btns">
                <button type="button" class="status-btn present {% if att.status == '出席' %}active{% endif %}"
                        onclick="selectStatus(this, '{{ player.id }}', '出席')">出席</button>
                <button type="button" class="status-btn absent {% if att.status == '欠席' %}active{% endif %}"
                        onclick="selectStatus(this, '{{ player.id }}', '欠席')">欠席</button>
                <button type="button" class="status-btn clear {% if not att.status %}active{% endif %}"
                        onclick="selectStatus(this, '{{ player.id }}', '')">クリア</button>
            </div>
            <input type="hidden" name="status_{{ player.id }}" id="status_{{ player.id }}" value="{{ att.status or '' }}">
        </div>
        {% else %}
        <div class="text-center py-3 text-muted">
            選手が登録されていません
        </div>
        {% endfor %}

        <!-- ゲストセクション -->
        <div class="guest-section" id="guestSection">
            <div class="guest-header">
                <span><i class="bi bi-person-plus"></i> ゲスト</span>
                <button type="button" class="btn btn-outline-primary btn-add-guest" onclick="addGuest()">
                    <i class="bi bi-plus"></i> 追加
                </button>
            </div>
            <div id="guestList">
                {% for guest in guests %}
                <div class="guest-row" data-guest-index="{{ loop.index0 }}">
                    <input type="text" class="form-control form-control-sm guest-name-input"
                           name="guest_name_{{ loop.index0 }}" value="{{ guest.name }}" placeholder="名前">
                    <div class="status-btns">
                        <button type="button" class="status-btn present {% if guest.status == '出席' %}active{% endif %}"
                                onclick="selectGuestStatus(this, {{ loop.index0 }}, '出席')">出席</button>
                        <button type="button" class="status-btn absent {% if guest.status == '欠席' %}active{% endif %}"
                                onclick="selectGuestStatus(this, {{ loop.index0 }}, '欠席')">欠席</button>
                        <button type="button" class="status-btn clear {% if not guest.status %}active{% endif %}"
                                onclick="selectGuestStatus(this, {{ loop.index0 }}, '')">クリア</button>
                    </div>
                    <input type="hidden" name="guest_status_{{ loop.index0 }}" id="guest_status_{{ loop.index0 }}" value="{{ guest.status or '出席' }}">
                    <button type="button" class="btn btn-outline-danger btn-remove-guest" onclick="removeGuest(this)">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        <input type="hidden" name="guest_count" id="guestCount" value="{{ guests|length }}">
    </div>

    <div class="d-grid">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg"></i> 保存
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
let guestIndex = {{ guests|length }};

function selectStatus(btn, playerId, status) {
    btn.parentElement.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('status_' + playerId).value = status;
    updateSummary();
}

function selectGuestStatus(btn, index, status) {
    btn.parentElement.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('guest_status_' + index).value = status;
    updateSummary();
}

function setAllStatus(status) {
    document.querySelectorAll('.player-row .status-btns').forEach(btns => {
        btns.querySelectorAll('.status-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.trim() === status) {
                btn.classList.add('active');
            }
        });
    });
    document.querySelectorAll('input[id^="status_"]:not([id^="guest_status_"])').forEach(input => {
        input.value = status;
    });
    updateSummary();
}

function clearAllStatus() {
    document.querySelectorAll('.player-row .status-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('input[id^="status_"]:not([id^="guest_status_"])').forEach(input => input.value = '');
    updateSummary();
}

function updateSummary() {
    let present = 0, absent = 0;
    // Player status
    document.querySelectorAll('input[id^="status_"]:not([id^="guest_status_"])').forEach(input => {
        if (input.value === '出席') present++;
        else if (input.value === '欠席') absent++;
    });
    // Guest status
    document.querySelectorAll('.guest-row').forEach(row => {
        const nameInput = row.querySelector('.guest-name-input');
        const statusInput = row.querySelector('input[id^="guest_status_"]');
        if (nameInput && nameInput.value.trim() && statusInput) {
            if (statusInput.value === '出席') present++;
            else if (statusInput.value === '欠席') absent++;
        }
    });
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = absent;
}

function addGuest() {
    const guestList = document.getElementById('guestList');
    const html = `
        <div class="guest-row" data-guest-index="${guestIndex}">
            <input type="text" class="form-control form-control-sm guest-name-input"
                   name="guest_name_${guestIndex}" placeholder="名前">
            <div class="status-btns">
                <button type="button" class="status-btn present active"
                        onclick="selectGuestStatus(this, ${guestIndex}, '出席')">出席</button>
                <button type="button" class="status-btn absent"
                        onclick="selectGuestStatus(this, ${guestIndex}, '欠席')">欠席</button>
                <button type="button" class="status-btn clear"
                        onclick="selectGuestStatus(this, ${guestIndex}, '')">クリア</button>
            </div>
            <input type="hidden" name="guest_status_${guestIndex}" id="guest_status_${guestIndex}" value="出席">
            <button type="button" class="btn btn-outline-danger btn-remove-guest" onclick="removeGuest(this)">
                <i class="bi bi-x"></i>
            </button>
        </div>
    `;
    guestList.insertAdjacentHTML('beforeend', html);
    guestIndex++;
    document.getElementById('guestCount').value = document.querySelectorAll('.guest-row').length;
    updateSummary();
}

function removeGuest(btn) {
    btn.closest('.guest-row').remove();
    document.getElementById('guestCount').value = document.querySelectorAll('.guest-row').length;
    updateSummary();
}

// Date navigation
document.getElementById('dateInput').addEventListener('change', function() {
    window.location.href = '/attendance?date=' + this.value;
});

document.getElementById('prevDateBtn').addEventListener('click', function(e) {
    e.preventDefault();
    const dateInput = document.getElementById('dateInput');
    const date = new Date(dateInput.value);
    date.setDate(date.getDate() - 1);
    dateInput.value = date.toISOString().split('T')[0];
    window.location.href = '/attendance?date=' + dateInput.value;
});

document.getElementById('nextDateBtn').addEventListener('click', function(e) {
    e.preventDefault();
    const dateInput = document.getElementById('dateInput');
    const date = new Date(dateInput.value);
    date.setDate(date.getDate() + 1);
    dateInput.value = date.toISOString().split('T')[0];
    window.location.href = '/attendance?date=' + dateInput.value;
});

// Initial summary
updateSummary();
</script>
{% endblock %}
