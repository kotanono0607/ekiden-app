{% extends "base.html" %}

{% block title %}出欠入力 - 南陽東置賜{% endblock %}

{% block extra_css %}
<style>
    .date-nav {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        margin-bottom: 16px;
    }
    .date-nav .btn {
        padding: 8px 12px;
    }
    .date-display {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-color);
    }
    .player-row {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
        gap: 12px;
    }
    .player-row:last-child {
        border-bottom: none;
    }
    .player-name {
        flex: 1;
        font-weight: 500;
        color: var(--text-color);
    }
    .status-btns {
        display: flex;
        gap: 4px;
    }
    .status-btn {
        padding: 4px 10px;
        border-radius: 16px;
        border: 1px solid var(--border-color);
        background: transparent;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.15s;
        color: var(--text-muted);
    }
    .status-btn:hover {
        border-color: #667eea;
    }
    .status-btn.active {
        background: #667eea;
        border-color: #667eea;
        color: white;
    }
    .status-btn.present.active { background: #10b981; border-color: #10b981; }
    .status-btn.absent.active { background: #ef4444; border-color: #ef4444; }
    .status-btn.late.active { background: #f59e0b; border-color: #f59e0b; }
    .status-btn.early.active { background: #6366f1; border-color: #6366f1; }
    .memo-input {
        width: 100px;
        font-size: 12px;
        padding: 4px 8px;
    }
    .quick-actions {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    .summary {
        display: flex;
        gap: 16px;
        justify-content: center;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    .summary-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
    }
    .summary-count {
        font-weight: 600;
        font-size: 18px;
    }
    .summary-item.present .summary-count { color: #10b981; }
    .summary-item.absent .summary-count { color: #ef4444; }
    .summary-item.late .summary-count { color: #f59e0b; }

    @media (max-width: 576px) {
        .player-row {
            flex-wrap: wrap;
        }
        .status-btns {
            width: 100%;
            justify-content: space-between;
            margin-top: 8px;
        }
        .memo-input {
            width: 100%;
            margin-top: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h5><i class="bi bi-person-check text-primary"></i> 出欠入力</h5>
    <a href="{{ url_for('calendar_view') }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-calendar3"></i>
    </a>
</div>

<div class="date-nav">
    {% set prev_date = (date|string)[:10] %}
    <a href="{{ url_for('attendance', date=prev_date) }}" class="btn btn-outline-secondary btn-sm" id="prevDateBtn">
        <i class="bi bi-chevron-left"></i>
    </a>
    <input type="date" class="form-control" id="dateInput" value="{{ date }}" style="width: auto;">
    <a href="{{ url_for('attendance', date=prev_date) }}" class="btn btn-outline-secondary btn-sm" id="nextDateBtn">
        <i class="bi bi-chevron-right"></i>
    </a>
</div>

<div class="summary" id="summary">
    <div class="summary-item present">
        <span>出席</span>
        <span class="summary-count" id="presentCount">0</span>
    </div>
    <div class="summary-item absent">
        <span>欠席</span>
        <span class="summary-count" id="absentCount">0</span>
    </div>
    <div class="summary-item late">
        <span>遅刻/早退</span>
        <span class="summary-count" id="lateCount">0</span>
    </div>
</div>

<div class="quick-actions">
    <button type="button" class="btn btn-success btn-sm" onclick="setAllStatus('出席')">
        <i class="bi bi-check-all"></i> 全員出席
    </button>
    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllStatus()">
        <i class="bi bi-x-lg"></i> クリア
    </button>
</div>

<form method="POST" action="{{ url_for('attendance_save') }}">
    <input type="hidden" name="date" value="{{ date }}">

    <div class="card mb-3">
        {% for player in players %}
        {% set att = attendance_by_player.get(player.id|string, {}) %}
        <div class="player-row">
            <div class="player-name">{{ player.name }}</div>
            <div class="status-btns">
                {% for code, name in status_list %}
                <button type="button" class="status-btn {% if code == '出席' %}present{% elif code == '欠席' %}absent{% else %}late{% endif %} {% if att.status == code %}active{% endif %}"
                        onclick="selectStatus(this, '{{ player.id }}', '{{ code }}')">
                    {{ name }}
                </button>
                {% endfor %}
            </div>
            <input type="hidden" name="status_{{ player.id }}" id="status_{{ player.id }}" value="{{ att.status or '' }}">
            <input type="text" class="form-control memo-input" name="memo_{{ player.id }}" value="{{ att.memo or '' }}" placeholder="備考">
        </div>
        {% else %}
        <div class="text-center py-4 text-muted">
            選手が登録されていません
        </div>
        {% endfor %}
    </div>

    <div class="d-grid">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg"></i> 保存
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
function selectStatus(btn, playerId, status) {
    // Remove active from siblings
    btn.parentElement.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
    // Add active to clicked
    btn.classList.add('active');
    // Update hidden input
    document.getElementById('status_' + playerId).value = status;
    // Update summary
    updateSummary();
}

function setAllStatus(status) {
    document.querySelectorAll('.status-btns').forEach(btns => {
        btns.querySelectorAll('.status-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.trim() === status) {
                btn.classList.add('active');
            }
        });
    });
    document.querySelectorAll('input[id^="status_"]').forEach(input => {
        input.value = status;
    });
    updateSummary();
}

function clearAllStatus() {
    document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('input[id^="status_"]').forEach(input => input.value = '');
    updateSummary();
}

function updateSummary() {
    let present = 0, absent = 0, late = 0;
    document.querySelectorAll('input[id^="status_"]').forEach(input => {
        if (input.value === '出席') present++;
        else if (input.value === '欠席') absent++;
        else if (input.value) late++;
    });
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = absent;
    document.getElementById('lateCount').textContent = late;
}

// Date navigation
document.getElementById('dateInput').addEventListener('change', function() {
    window.location.href = '/attendance?date=' + this.value;
});

document.getElementById('prevDateBtn').addEventListener('click', function(e) {
    e.preventDefault();
    const dateInput = document.getElementById('dateInput');
    const date = new Date(dateInput.value);
    date.setDate(date.getDate() - 1);
    dateInput.value = date.toISOString().split('T')[0];
    window.location.href = '/attendance?date=' + dateInput.value;
});

document.getElementById('nextDateBtn').addEventListener('click', function(e) {
    e.preventDefault();
    const dateInput = document.getElementById('dateInput');
    const date = new Date(dateInput.value);
    date.setDate(date.getDate() + 1);
    dateInput.value = date.toISOString().split('T')[0];
    window.location.href = '/attendance?date=' + dateInput.value;
});

// Initial summary
updateSummary();
</script>
{% endblock %}
