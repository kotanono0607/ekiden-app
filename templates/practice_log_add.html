{% extends "base.html" %}

{% block title %}ç·´ç¿’æ—¥èªŒè¿½åŠ  - å—é™½æ±ç½®è³œ{% endblock %}

{% block extra_css %}
<style>
    .section-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid #667eea;
    }
    /* å‡ºæ¬ ã‚¹ã‚¿ã‚¤ãƒ« */
    .player-row {
        display: flex;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid var(--border-color);
        gap: 8px;
    }
    .player-row:last-child { border-bottom: none; }
    .player-name {
        flex: 1;
        font-size: 14px;
        color: var(--text-color);
    }
    .status-btns { display: flex; gap: 4px; }
    .status-btn {
        padding: 2px 10px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        background: transparent;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.15s;
        color: var(--text-muted);
    }
    .status-btn:hover { border-color: #667eea; }
    .status-btn.active { background: #667eea; border-color: #667eea; color: white; }
    .status-btn.present.active { background: #10b981; border-color: #10b981; }
    .status-btn.absent.active { background: #ef4444; border-color: #ef4444; }
    .status-btn.clear { color: var(--text-muted); }
    .summary-inline {
        display: flex;
        gap: 12px;
        margin-bottom: 8px;
        font-size: 13px;
    }
    .summary-inline span { color: var(--text-muted); }
    .summary-inline .count { font-weight: 600; }
    .summary-inline .present { color: #10b981; }
    .summary-inline .absent { color: #ef4444; }
    .quick-actions {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
    }
    .guest-section {
        border-top: 1px dashed var(--border-color);
        margin-top: 8px;
        padding-top: 8px;
    }
    .guest-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 12px;
        color: var(--text-muted);
    }
    .guest-row {
        display: flex;
        align-items: center;
        padding: 6px 0;
        gap: 8px;
    }
    .guest-name-input {
        flex: 1;
        font-size: 12px;
        padding: 3px 8px;
        max-width: 120px;
    }
    .btn-add-guest, .btn-remove-guest {
        font-size: 11px;
        padding: 2px 6px;
    }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼å…¥åŠ›ã‚¹ã‚¿ã‚¤ãƒ« */
    .menu-type-tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }
    .menu-type-tab {
        padding: 6px 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: transparent;
        font-size: 12px;
        cursor: pointer;
        color: var(--text-muted);
        transition: all 0.15s;
    }
    .menu-type-tab:hover { border-color: #667eea; }
    .menu-type-tab.active {
        background: #667eea;
        border-color: #667eea;
        color: white;
    }
    .menu-form { display: none; }
    .menu-form.active { display: block; }
    .menu-item {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
    }
    .menu-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .menu-item-title {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-color);
    }
    .lap-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
    }
    .lap-input, .time-input {
        width: 80px;
        font-size: 18px;
        font-weight: 600;
        padding: 10px 12px;
        text-align: center;
        border-radius: 8px;
        border: 2px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-color);
        transition: all 0.15s;
    }
    .lap-input:focus, .time-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        outline: none;
    }
    .lap-input.filled, .time-input.filled {
        background: rgba(16, 185, 129, 0.1);
        border-color: #10b981;
    }
    .lap-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-color);
        min-width: 60px;
    }
    /* ã‚¿ã‚¤ãƒ å…¥åŠ›ã‚°ãƒªãƒƒãƒ‰ */
    .time-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 8px;
    }
    .time-cell {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .time-cell-label {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 2px;
    }
    .time-hint {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 4px;
    }
    .result-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
    }
    .result-rank {
        width: 40px;
        font-size: 12px;
        padding: 4px 6px;
    }
    .result-player {
        flex: 1;
        font-size: 12px;
        padding: 4px 8px;
        max-width: 100px;
    }
    .result-time {
        width: 80px;
        font-size: 12px;
        padding: 4px 8px;
    }
    .added-menus {
        margin-top: 12px;
    }
    .added-menu-item {
        background: rgba(102, 126, 234, 0.1);
        border-radius: 8px;
        padding: 10px 12px;
        margin-bottom: 6px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    .added-menu-content {
        flex: 1;
    }
    .added-menu-type {
        font-size: 11px;
        color: #667eea;
        margin-bottom: 2px;
    }
    .added-menu-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-color);
    }
    .added-menu-detail {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 2px;
    }
    .added-menu-group {
        font-size: 10px;
        color: #f59e0b;
        margin-top: 2px;
    }
    /* ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠã‚¹ã‚¿ã‚¤ãƒ« */
    .group-selector {
        background: rgba(102, 126, 234, 0.05);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 12px;
    }
    .group-btns {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }
    .group-btn {
        padding: 4px 12px;
        border-radius: 14px;
        border: 1px solid var(--border-color);
        background: transparent;
        font-size: 12px;
        cursor: pointer;
        color: var(--text-muted);
        transition: all 0.15s;
    }
    .group-btn:hover { border-color: #f59e0b; }
    .group-btn.active {
        background: #f59e0b;
        border-color: #f59e0b;
        color: white;
    }
    .group-btn.group-a.active { background: #3b82f6; border-color: #3b82f6; }
    .group-btn.group-b.active { background: #10b981; border-color: #10b981; }
    .group-btn.group-c.active { background: #f59e0b; border-color: #f59e0b; }
    .member-selector {
        margin-top: 8px;
        display: none;
    }
    .member-selector.active { display: block; }
    .member-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }
    .member-check {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
        border-radius: 12px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        font-size: 11px;
        cursor: pointer;
        color: var(--text-color);
    }
    .member-check:hover { border-color: #667eea; }
    .member-check.selected {
        background: rgba(102, 126, 234, 0.2);
        border-color: #667eea;
    }
    .member-check input { display: none; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h5><i class="bi bi-journal-plus text-primary"></i> ç·´ç¿’æ—¥èªŒè¿½åŠ </h5>
    <a href="{{ url_for('practice_logs') }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> æˆ»ã‚‹
    </a>
</div>

<form method="POST" id="mainForm" onsubmit="return prepareSubmit()">
    <!-- ç·´ç¿’æ—¥èªŒæƒ…å ± -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="section-title"><i class="bi bi-journal-text"></i> ç·´ç¿’æƒ…å ±</div>

            <div class="mb-3">
                <label class="form-label">æ—¥ä»˜ <span class="text-danger">*</span></label>
                <input type="date" class="form-control" name="date" value="{{ date }}" required>
            </div>

            <div class="mb-3">
                <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ« <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="title" value="å—é™½ãƒ»æ±ç½®è³œç·´ç¿’ä¼š" required>
            </div>

            <div class="row">
                <div class="col-6">
                    <div class="mb-3">
                        <label class="form-label">å¤©å€™</label>
                        <select class="form-select" name="weather">
                            <option value="">é¸æŠ</option>
                            {% for code, name in weather_list %}
                            <option value="{{ code }}">{{ name }}</option>
                            {% endfor %}
                            {% if not weather_list %}
                            <option value="æ™´ã‚Œ">æ™´ã‚Œ</option>
                            <option value="æ›‡ã‚Š">æ›‡ã‚Š</option>
                            <option value="é›¨">é›¨</option>
                            <option value="é›ª">é›ª</option>
                            {% endif %}
                        </select>
                    </div>
                </div>
                <div class="col-6">
                    <div class="mb-3">
                        <label class="form-label">æ°—æ¸© (â„ƒ)</label>
                        <input type="number" class="form-control" name="temperature" placeholder="20">
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">ãƒ¡ãƒ¢</label>
                <textarea class="form-control" name="memo" rows="2" placeholder="ãƒãƒ¼ãƒ å…¨ä½“ã®é›°å›²æ°—ã€ç‰¹è¨˜äº‹é …ãªã©"></textarea>
            </div>

            <input type="hidden" name="participants" id="participantsInput" value="">
            <input type="hidden" name="content" id="contentInput" value="">
            <input type="hidden" name="menu_data" id="menuDataInput" value="">
        </div>
    </div>

    <!-- å‡ºæ¬ å…¥åŠ›ï¼ˆç·´ç¿’æƒ…å ±ã®ç›´å¾Œã«ç§»å‹•ï¼‰ -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="section-title"><i class="bi bi-person-check"></i> å‡ºæ¬ å…¥åŠ›</div>

            <div class="summary-inline">
                <span>å‡ºå¸­ <span class="count present" id="presentCount">0</span></span>
                <span>æ¬ å¸­ <span class="count absent" id="absentCount">0</span></span>
            </div>

            <div class="quick-actions">
                <button type="button" class="btn btn-success btn-sm" onclick="setAllStatus('å‡ºå¸­')">
                    <i class="bi bi-check-all"></i> å…¨å“¡å‡ºå¸­
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllStatus()">
                    <i class="bi bi-x-lg"></i> ã‚¯ãƒªã‚¢
                </button>
            </div>

            {% for player in players %}
            <div class="player-row">
                <div class="player-name">{{ player.name }}</div>
                <div class="status-btns">
                    <button type="button" class="status-btn present" onclick="selectStatus(this, '{{ player.id }}', 'å‡ºå¸­')">å‡ºå¸­</button>
                    <button type="button" class="status-btn absent" onclick="selectStatus(this, '{{ player.id }}', 'æ¬ å¸­')">æ¬ å¸­</button>
                    <button type="button" class="status-btn clear active" onclick="selectStatus(this, '{{ player.id }}', '')">ã‚¯ãƒªã‚¢</button>
                </div>
                <input type="hidden" name="status_{{ player.id }}" id="status_{{ player.id }}" value="">
            </div>
            {% else %}
            <div class="text-center py-3 text-muted">é¸æ‰‹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
            {% endfor %}

            <div class="guest-section">
                <div class="guest-header">
                    <span><i class="bi bi-person-plus"></i> ã‚²ã‚¹ãƒˆ</span>
                    <button type="button" class="btn btn-outline-primary btn-add-guest" onclick="addGuest()">
                        <i class="bi bi-plus"></i> è¿½åŠ 
                    </button>
                </div>
                <div id="guestList"></div>
            </div>
            <input type="hidden" name="guest_count" id="guestCount" value="0">
        </div>
    </div>

    <!-- ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="section-title"><i class="bi bi-list-check"></i> ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>

            <!-- ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠï¼ˆå…ˆã«è¡¨ç¤ºï¼‰ -->
            <div class="group-selector">
                <label class="form-label" style="font-size:12px;margin-bottom:6px;">ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠ</label>
                <div class="group-btns">
                    <button type="button" class="group-btn group-a" onclick="selectGroup('A')">A</button>
                    <button type="button" class="group-btn group-b" onclick="selectGroup('B')">B</button>
                    <button type="button" class="group-btn group-c" onclick="selectGroup('C')">C</button>
                    <button type="button" class="group-btn active" onclick="selectGroup('')">ãªã—</button>
                </div>
                <div class="member-selector" id="memberSelector">
                    <label class="form-label" style="font-size:11px;margin-bottom:4px;margin-top:8px;">å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆå‡ºå¸­è€…ã‹ã‚‰é¸æŠï¼‰</label>
                    <div class="member-checkboxes" id="memberCheckboxes">
                        <!-- å‡ºå¸­è€…ã®ã¿å‹•çš„ã«è¡¨ç¤º -->
                    </div>
                    <div class="text-muted" style="font-size:11px;margin-top:4px;" id="noAttendeeMsg">
                        â€»å…ˆã«å‡ºæ¬ ã§å‡ºå¸­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„
                    </div>
                </div>
            </div>

            <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¿ã‚¤ãƒ—é¸æŠ -->
            <div class="menu-type-tabs">
                <button type="button" class="menu-type-tab active" onclick="switchMenuType('pace')">ãƒšãƒ¼ã‚¹èµ°</button>
                <button type="button" class="menu-type-tab" onclick="switchMenuType('interval')">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«</button>
                <button type="button" class="menu-type-tab" onclick="switchMenuType('tt')">TT/ãƒ•ãƒªãƒ¼</button>
            </div>

            <!-- ãƒšãƒ¼ã‚¹èµ°ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="menuFormPace" class="menu-form active">
                <div class="row mb-2">
                    <div class="col-6">
                        <label class="form-label" style="font-size:12px;">ç·è·é›¢</label>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control" id="paceDistance" placeholder="12000">
                            <span class="input-group-text">m</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <label class="form-label" style="font-size:12px;">ãƒ©ãƒƒãƒ—é–“éš”</label>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control" id="paceLapInterval" value="1000" placeholder="1000">
                            <span class="input-group-text">mã”ã¨</span>
                            <button type="button" class="btn btn-outline-primary" onclick="generatePaceLaps()">ç”Ÿæˆ</button>
                        </div>
                    </div>
                </div>
                <div id="paceLapsContainer" class="mb-2"></div>
                <div class="mb-2">
                    <label class="form-label" style="font-size:12px;">ãƒˆãƒ¼ã‚¿ãƒ«ã‚¿ã‚¤ãƒ </label>
                    <input type="text" class="form-control form-control-sm" id="paceTotalTime" placeholder="42:44" readonly>
                </div>
                <button type="button" class="btn btn-primary btn-sm" onclick="addPaceMenu()">
                    <i class="bi bi-plus"></i> ãƒšãƒ¼ã‚¹èµ°ã‚’è¿½åŠ 
                </button>
            </div>

            <!-- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="menuFormInterval" class="menu-form">
                <div class="row mb-2">
                    <div class="col-4">
                        <label class="form-label" style="font-size:12px;">è·é›¢</label>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control" id="intervalDistance" placeholder="400">
                            <span class="input-group-text">m</span>
                        </div>
                    </div>
                    <div class="col-4">
                        <label class="form-label" style="font-size:12px;">æœ¬æ•°</label>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control" id="intervalReps" placeholder="10">
                            <button type="button" class="btn btn-outline-primary" onclick="generateIntervalTimes()">ç”Ÿæˆ</button>
                        </div>
                    </div>
                    <div class="col-4">
                        <label class="form-label" style="font-size:12px;">è¨­å®š</label>
                        <input type="text" class="form-control form-control-sm" id="intervalPace" placeholder="70ç§’">
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label" style="font-size:12px;">ãƒ¬ã‚¹ãƒˆ</label>
                    <input type="text" class="form-control form-control-sm" id="intervalRest" placeholder="200mã‚¸ãƒ§ã‚°">
                </div>
                <div id="intervalTimesContainer" class="mb-2"></div>
                <button type="button" class="btn btn-primary btn-sm" onclick="addIntervalMenu()">
                    <i class="bi bi-plus"></i> ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’è¿½åŠ 
                </button>
            </div>

            <!-- TT/ãƒ•ãƒªãƒ¼ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="menuFormTT" class="menu-form">
                <div class="row mb-2">
                    <div class="col-6">
                        <label class="form-label" style="font-size:12px;">ç¨®ç›®å</label>
                        <input type="text" class="form-control form-control-sm" id="ttName" placeholder="1000m TT">
                    </div>
                    <div class="col-6">
                        <label class="form-label" style="font-size:12px;">è·é›¢</label>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control" id="ttDistance" placeholder="1000">
                            <span class="input-group-text">m</span>
                        </div>
                    </div>
                </div>
                <div id="ttResultsContainer" class="mb-2">
                    <label class="form-label" style="font-size:12px;">å€‹äººã‚¿ã‚¤ãƒ </label>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm mb-2" onclick="addTTResult()">
                    <i class="bi bi-plus"></i> é¸æ‰‹è¿½åŠ 
                </button>
                <br>
                <button type="button" class="btn btn-primary btn-sm" onclick="addTTMenu()">
                    <i class="bi bi-plus"></i> TTã‚’è¿½åŠ 
                </button>
            </div>

            <!-- è¿½åŠ æ¸ˆã¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
            <div class="added-menus" id="addedMenus"></div>
        </div>
    </div>

    <div class="d-grid">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg"></i> ç™»éŒ²
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿
let menus = [];
let guestIndex = 0;
let ttResultIndex = 0;
let currentGroup = '';

// ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠ
function selectGroup(group) {
    currentGroup = group;
    document.querySelectorAll('.group-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    const memberSelector = document.getElementById('memberSelector');
    if (group) {
        memberSelector.classList.add('active');
        updateMemberCheckboxes();
    } else {
        memberSelector.classList.remove('active');
    }
}

// å‡ºå¸­è€…ã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼é¸æŠè‚¢ã‚’æ›´æ–°
function updateMemberCheckboxes() {
    const container = document.getElementById('memberCheckboxes');
    const noAttendeeMsg = document.getElementById('noAttendeeMsg');
    const attendees = getAttendees();

    if (attendees.length === 0) {
        container.innerHTML = '';
        noAttendeeMsg.style.display = 'block';
        return;
    }

    noAttendeeMsg.style.display = 'none';
    let html = '';
    attendees.forEach(attendee => {
        html += `
            <label class="member-check" onclick="toggleMember(this)">
                <input type="checkbox" value="${attendee.id}" data-name="${attendee.name}">
                ${attendee.name}
            </label>
        `;
    });
    container.innerHTML = html;
}

// å‡ºå¸­è€…ã‚’å–å¾—
function getAttendees() {
    const attendees = [];
    // é¸æ‰‹ã®å‡ºå¸­è€…
    document.querySelectorAll('.player-row').forEach(row => {
        const nameEl = row.querySelector('.player-name');
        const statusInput = row.querySelector('input[id^="status_"]');
        if (nameEl && statusInput && statusInput.value === 'å‡ºå¸­') {
            const id = statusInput.id.replace('status_', '');
            attendees.push({ id: id, name: nameEl.textContent.trim() });
        }
    });
    // ã‚²ã‚¹ãƒˆã®å‡ºå¸­è€…
    document.querySelectorAll('.guest-row').forEach(row => {
        const nameInput = row.querySelector('.guest-name-input');
        const statusInput = row.querySelector('input[id^="guest_status_"]');
        if (nameInput && nameInput.value.trim() && statusInput && statusInput.value === 'å‡ºå¸­') {
            const guestId = 'GUEST_' + row.dataset.guestIndex;
            attendees.push({ id: guestId, name: nameInput.value.trim() });
        }
    });
    return attendees;
}

function toggleMember(label) {
    const checkbox = label.querySelector('input');
    checkbox.checked = !checkbox.checked;
    if (checkbox.checked) {
        label.classList.add('selected');
    } else {
        label.classList.remove('selected');
    }
}

function getSelectedMembers() {
    const members = [];
    document.querySelectorAll('.member-check input:checked').forEach(input => {
        members.push({
            id: input.value,
            name: input.dataset.name
        });
    });
    return members;
}

function resetGroupSelection() {
    currentGroup = '';
    document.querySelectorAll('.group-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.group-btn')[3].classList.add('active'); // ã€Œãªã—ã€ã‚’é¸æŠï¼ˆ4ç•ªç›®ï¼‰
    document.getElementById('memberSelector').classList.remove('active');
}

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ
function switchMenuType(type) {
    document.querySelectorAll('.menu-type-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.menu-form').forEach(f => f.classList.remove('active'));
    event.target.classList.add('active');
    if (type === 'pace') document.getElementById('menuFormPace').classList.add('active');
    else if (type === 'interval') document.getElementById('menuFormInterval').classList.add('active');
    else if (type === 'tt') document.getElementById('menuFormTT').classList.add('active');
}

// ã‚¿ã‚¤ãƒ è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆ335â†’3:35ã€70â†’70ï¼‰
function formatTimeInput(input) {
    let val = input.value.replace(/[^0-9]/g, '');
    if (val.length >= 3) {
        // 3æ¡ä»¥ä¸Šãªã‚‰åˆ†:ç§’ã«å¤‰æ›
        const sec = val.slice(-2);
        const min = val.slice(0, -2);
        input.value = min + ':' + sec;
    }
    // å…¥åŠ›æ¸ˆã¿ã‚¹ã‚¿ã‚¤ãƒ«
    if (input.value.trim()) {
        input.classList.add('filled');
    } else {
        input.classList.remove('filled');
    }
}

// æ¬¡ã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•
function moveToNextInput(currentInput, e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const allInputs = Array.from(document.querySelectorAll('.time-input, .lap-input'));
        const idx = allInputs.indexOf(currentInput);
        if (idx >= 0 && idx < allInputs.length - 1) {
            allInputs[idx + 1].focus();
            allInputs[idx + 1].select();
        }
    }
}

// ãƒšãƒ¼ã‚¹èµ°ãƒ©ãƒƒãƒ—ç”Ÿæˆ
function generatePaceLaps() {
    const total = parseInt(document.getElementById('paceDistance').value) || 0;
    const interval = parseInt(document.getElementById('paceLapInterval').value) || 1000;
    const container = document.getElementById('paceLapsContainer');
    container.innerHTML = '';

    if (total <= 0) return;

    let html = '<div class="time-hint">ğŸ’¡ æ•°å­—ã ã‘å…¥åŠ› â†’ è‡ªå‹•ã§ã€Œ:ã€æŒ¿å…¥ï¼ˆ335â†’3:35ï¼‰ã€Enterã§æ¬¡ã¸</div>';
    for (let d = interval; d <= total; d += interval) {
        html += `
            <div class="lap-row">
                <span class="lap-label">${d}m</span>
                <input type="text" class="lap-input time-input" id="paceLap_${d}"
                       inputmode="numeric" placeholder="3:35"
                       onblur="formatTimeInput(this); calculatePaceTotal()"
                       onkeydown="moveToNextInput(this, event)">
            </div>
        `;
    }
    container.innerHTML = html;

    // æœ€åˆã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    setTimeout(() => {
        const firstInput = container.querySelector('.lap-input');
        if (firstInput) firstInput.focus();
    }, 100);
}

// ãƒšãƒ¼ã‚¹èµ°ãƒˆãƒ¼ã‚¿ãƒ«è¨ˆç®—
function calculatePaceTotal() {
    let totalSeconds = 0;
    document.querySelectorAll('#paceLapsContainer input').forEach(input => {
        const time = input.value.trim();
        if (time) {
            const parts = time.split(':');
            if (parts.length === 2) {
                totalSeconds += parseInt(parts[0]) * 60 + parseInt(parts[1]);
            }
        }
    });
    if (totalSeconds > 0) {
        const min = Math.floor(totalSeconds / 60);
        const sec = totalSeconds % 60;
        document.getElementById('paceTotalTime').value = `${min}:${sec.toString().padStart(2, '0')}`;
    }
}

// ãƒšãƒ¼ã‚¹èµ°è¿½åŠ 
function addPaceMenu() {
    const distance = document.getElementById('paceDistance').value;
    const totalTime = document.getElementById('paceTotalTime').value;

    if (!distance) { alert('è·é›¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

    const laps = [];
    document.querySelectorAll('#paceLapsContainer .lap-input').forEach(input => {
        const d = input.id.replace('paceLap_', '');
        if (input.value.trim()) {
            laps.push({ distance: d + 'm', time: input.value.trim() });
        }
    });

    const menu = {
        type: 'pace_run',
        name: `${distance}mãƒšãƒ¼ã‚¹èµ°`,
        distance: distance + 'm',
        laps: laps,
        total: totalTime,
        group: currentGroup,
        members: getSelectedMembers()
    };
    menus.push(menu);
    renderAddedMenus();

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('paceDistance').value = '';
    document.getElementById('paceLapsContainer').innerHTML = '';
    document.getElementById('paceTotalTime').value = '';
    resetGroupSelection();
}

// ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›æ¬„ç”Ÿæˆ
function generateIntervalTimes() {
    const reps = parseInt(document.getElementById('intervalReps').value) || 0;
    const distance = parseInt(document.getElementById('intervalDistance').value) || 0;
    const container = document.getElementById('intervalTimesContainer');
    container.innerHTML = '';

    if (reps <= 0 || reps > 30) return;

    // è·é›¢ã«å¿œã˜ãŸãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
    let placeholder = '70';
    if (distance >= 1000) placeholder = '3:20';
    else if (distance >= 600) placeholder = '1:50';
    else if (distance >= 300) placeholder = '50';

    let html = '<label class="form-label" style="font-size:12px;">å„æœ¬ã‚¿ã‚¤ãƒ </label>';
    html += '<div class="time-hint">ğŸ’¡ æ•°å­—ã ã‘å…¥åŠ› â†’ è‡ªå‹•ã§ã€Œ:ã€æŒ¿å…¥ï¼ˆ335â†’3:35ï¼‰ã€Enterã§æ¬¡ã¸</div>';
    html += '<div class="time-grid">';
    for (let i = 1; i <= reps; i++) {
        html += `
            <div class="time-cell">
                <span class="time-cell-label">${i}æœ¬ç›®</span>
                <input type="text" class="time-input" id="intervalTime_${i}"
                       inputmode="numeric" placeholder="${placeholder}"
                       onblur="formatTimeInput(this)"
                       onkeydown="moveToNextInput(this, event)">
            </div>
        `;
    }
    html += '</div>';
    container.innerHTML = html;

    // æœ€åˆã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    setTimeout(() => {
        const firstInput = container.querySelector('.time-input');
        if (firstInput) firstInput.focus();
    }, 100);
}

// ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¿½åŠ 
function addIntervalMenu() {
    const distance = document.getElementById('intervalDistance').value;
    const reps = document.getElementById('intervalReps').value;
    const pace = document.getElementById('intervalPace').value;
    const rest = document.getElementById('intervalRest').value;

    if (!distance || !reps) { alert('è·é›¢ã¨æœ¬æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

    // å„æœ¬ã®ã‚¿ã‚¤ãƒ ã‚’åé›†
    const times = [];
    for (let i = 1; i <= parseInt(reps); i++) {
        const timeInput = document.getElementById('intervalTime_' + i);
        if (timeInput && timeInput.value.trim()) {
            times.push({ rep: i, time: timeInput.value.trim() });
        }
    }

    const menu = {
        type: 'interval',
        name: `${distance}mÃ—${reps}`,
        distance: distance + 'm',
        reps: parseInt(reps),
        pace: pace,
        rest: rest,
        times: times,
        group: currentGroup,
        members: getSelectedMembers()
    };
    menus.push(menu);
    renderAddedMenus();

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('intervalDistance').value = '';
    document.getElementById('intervalReps').value = '';
    document.getElementById('intervalPace').value = '';
    document.getElementById('intervalRest').value = '';
    document.getElementById('intervalTimesContainer').innerHTML = '';
    resetGroupSelection();
}

// TTçµæœè¡Œè¿½åŠ 
function addTTResult() {
    const container = document.getElementById('ttResultsContainer');
    const html = `
        <div class="result-row" id="ttResult_${ttResultIndex}">
            <input type="number" class="form-control result-rank" placeholder="#" id="ttRank_${ttResultIndex}">
            <input type="text" class="form-control result-player" placeholder="é¸æ‰‹å" id="ttPlayer_${ttResultIndex}">
            <input type="text" class="form-control result-time" placeholder="2:52.7" id="ttTime_${ttResultIndex}">
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeTTResult(${ttResultIndex})">
                <i class="bi bi-x"></i>
            </button>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    ttResultIndex++;
}

function removeTTResult(idx) {
    document.getElementById('ttResult_' + idx)?.remove();
}

// TTè¿½åŠ 
function addTTMenu() {
    const name = document.getElementById('ttName').value || 'TT';
    const distance = document.getElementById('ttDistance').value;

    const results = [];
    document.querySelectorAll('#ttResultsContainer .result-row').forEach(row => {
        const idx = row.id.replace('ttResult_', '');
        const rank = document.getElementById('ttRank_' + idx)?.value;
        const player = document.getElementById('ttPlayer_' + idx)?.value;
        const time = document.getElementById('ttTime_' + idx)?.value;
        if (player && time) {
            results.push({ rank: parseInt(rank) || 0, player: player, time: time });
        }
    });

    const menu = {
        type: 'tt',
        name: name,
        distance: distance ? distance + 'm' : '',
        results: results,
        group: currentGroup,
        members: getSelectedMembers()
    };
    menus.push(menu);
    renderAddedMenus();

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('ttName').value = '';
    document.getElementById('ttDistance').value = '';
    document.getElementById('ttResultsContainer').innerHTML = '<label class="form-label" style="font-size:12px;">å€‹äººã‚¿ã‚¤ãƒ </label>';
    ttResultIndex = 0;
    resetGroupSelection();
}

// è¿½åŠ æ¸ˆã¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
function renderAddedMenus() {
    const container = document.getElementById('addedMenus');
    if (menus.length === 0) {
        container.innerHTML = '';
        return;
    }

    let html = '<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">è¿½åŠ æ¸ˆã¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼:</div>';
    menus.forEach((menu, idx) => {
        let detail = '';
        if (menu.type === 'pace_run') {
            detail = menu.laps.length + 'æœ¬ãƒ©ãƒƒãƒ—';
            if (menu.total) detail += ' / total ' + menu.total;
        } else if (menu.type === 'interval') {
            if (menu.times && menu.times.length > 0) {
                detail = menu.times.length + 'æœ¬è¨˜éŒ²';
            } else {
                detail = menu.pace || '';
            }
            if (menu.rest) detail += (detail ? ' / ' : '') + 'ãƒ¬ã‚¹ãƒˆ ' + menu.rest;
        } else if (menu.type === 'tt') {
            detail = menu.results.length + 'åå‚åŠ ';
            if (menu.results.length > 0 && menu.results[0].player) {
                detail += ' / 1ä½ ' + menu.results[0].player + ' ' + menu.results[0].time;
            }
        }

        const typeLabel = menu.type === 'pace_run' ? 'ãƒšãƒ¼ã‚¹èµ°' : menu.type === 'interval' ? 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«' : 'TT';
        let groupInfo = '';
        if (menu.group) {
            groupInfo = `${menu.group}ã‚°ãƒ«ãƒ¼ãƒ—`;
            if (menu.members && menu.members.length > 0) {
                groupInfo += ': ' + menu.members.map(m => m.name).join(', ');
            }
        }
        html += `
            <div class="added-menu-item">
                <div class="added-menu-content">
                    <div class="added-menu-type">${typeLabel}</div>
                    <div class="added-menu-name">${menu.name}</div>
                    <div class="added-menu-detail">${detail}</div>
                    ${groupInfo ? `<div class="added-menu-group"><i class="bi bi-people-fill"></i> ${groupInfo}</div>` : ''}
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeMenu(${idx})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
    });
    container.innerHTML = html;
}

function removeMenu(idx) {
    menus.splice(idx, 1);
    renderAddedMenus();
}

// å‡ºæ¬ é–¢é€£
function selectStatus(btn, playerId, status) {
    btn.parentElement.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('status_' + playerId).value = status;
    updateSummary();
}

function selectGuestStatus(btn, index, status) {
    btn.parentElement.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('guest_status_' + index).value = status;
    updateSummary();
}

function setAllStatus(status) {
    document.querySelectorAll('.player-row .status-btns').forEach(btns => {
        btns.querySelectorAll('.status-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.trim() === status) btn.classList.add('active');
        });
    });
    document.querySelectorAll('input[id^="status_"]:not([id^="guest_status_"])').forEach(input => {
        input.value = status;
    });
    updateSummary();
}

function clearAllStatus() {
    document.querySelectorAll('.player-row .status-btns').forEach(btns => {
        btns.querySelectorAll('.status-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.trim() === 'ã‚¯ãƒªã‚¢') btn.classList.add('active');
        });
    });
    document.querySelectorAll('input[id^="status_"]:not([id^="guest_status_"])').forEach(input => input.value = '');
    updateSummary();
}

function updateSummary() {
    let present = 0, absent = 0;
    document.querySelectorAll('input[id^="status_"]:not([id^="guest_status_"])').forEach(input => {
        if (input.value === 'å‡ºå¸­') present++;
        else if (input.value === 'æ¬ å¸­') absent++;
    });
    document.querySelectorAll('.guest-row').forEach(row => {
        const nameInput = row.querySelector('.guest-name-input');
        const statusInput = row.querySelector('input[id^="guest_status_"]');
        if (nameInput && nameInput.value.trim() && statusInput) {
            if (statusInput.value === 'å‡ºå¸­') present++;
            else if (statusInput.value === 'æ¬ å¸­') absent++;
        }
    });
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = absent;
    document.getElementById('participantsInput').value = present > 0 ? present : '';
}

function addGuest() {
    const guestList = document.getElementById('guestList');
    const html = `
        <div class="guest-row" data-guest-index="${guestIndex}">
            <input type="text" class="form-control form-control-sm guest-name-input"
                   name="guest_name_${guestIndex}" placeholder="åå‰" oninput="updateSummary()">
            <div class="status-btns">
                <button type="button" class="status-btn present active" onclick="selectGuestStatus(this, ${guestIndex}, 'å‡ºå¸­')">å‡ºå¸­</button>
                <button type="button" class="status-btn absent" onclick="selectGuestStatus(this, ${guestIndex}, 'æ¬ å¸­')">æ¬ å¸­</button>
                <button type="button" class="status-btn clear" onclick="selectGuestStatus(this, ${guestIndex}, '')">ã‚¯ãƒªã‚¢</button>
            </div>
            <input type="hidden" name="guest_status_${guestIndex}" id="guest_status_${guestIndex}" value="å‡ºå¸­">
            <button type="button" class="btn btn-outline-danger btn-remove-guest" onclick="removeGuest(this)">
                <i class="bi bi-x"></i>
            </button>
        </div>
    `;
    guestList.insertAdjacentHTML('beforeend', html);
    guestIndex++;
    document.getElementById('guestCount').value = document.querySelectorAll('.guest-row').length;
    updateSummary();
}

function removeGuest(btn) {
    btn.closest('.guest-row').remove();
    document.getElementById('guestCount').value = document.querySelectorAll('.guest-row').length;
    updateSummary();
}

// é€ä¿¡å‰å‡¦ç†
function prepareSubmit() {
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’JSONã«
    document.getElementById('menuDataInput').value = JSON.stringify({ menus: menus });

    // contentãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã‚‚ç”Ÿæˆ
    let content = '';
    menus.forEach(menu => {
        // ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±
        if (menu.group) {
            content += `ã€${menu.group}ã‚°ãƒ«ãƒ¼ãƒ—ã€‘`;
            if (menu.members && menu.members.length > 0) {
                content += ' ' + menu.members.map(m => m.name).join(', ');
            }
            content += '\n';
        }

        if (menu.type === 'pace_run') {
            content += menu.name + '\n';
            menu.laps.forEach(lap => {
                content += `${lap.distance} ${lap.time}\n`;
            });
            if (menu.total) content += `total ${menu.total}\n`;
            content += '\n';
        } else if (menu.type === 'interval') {
            content += `${menu.name}`;
            if (menu.pace) content += ` è¨­å®š${menu.pace}`;
            if (menu.rest) content += ` ãƒ¬ã‚¹ãƒˆ${menu.rest}`;
            content += '\n';
            if (menu.times && menu.times.length > 0) {
                menu.times.forEach(t => {
                    content += `${t.rep}æœ¬ç›® ${t.time}\n`;
                });
            }
            content += '\n';
        } else if (menu.type === 'tt') {
            content += menu.name + '\n';
            menu.results.forEach(r => {
                content += `${r.rank ? r.rank + 'ä½ ' : ''}${r.player} ${r.time}\n`;
            });
            content += '\n';
        }
    });
    document.getElementById('contentInput').value = content.trim();
    return true; // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’ç¶šè¡Œ
}

// åˆæœŸåŒ–
updateSummary();
</script>
{% endblock %}
