<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#74b9ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <title>{% block title %}南陽・東置賜駅伝{% endblock %}</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            --primary-color: #74b9ff;
            --primary-dark: #5a9fd4;
            --accent-color: #a29bfe;
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            /* Light theme (default) */
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --input-bg: #ffffff;
            --nav-bg: #ffffff;
            --menu-bg: #ffffff;
            --dropdown-bg: #ffffff;
        }
        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #e2e8f0;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --input-bg: #1e293b;
            --nav-bg: #1e293b;
            --menu-bg: #1e293b;
            --dropdown-bg: #1e293b;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-bottom: 70px; /* Space for bottom nav */
            transition: background-color 0.3s, color 0.3s;
        }
        @media (min-width: 992px) {
            body {
                padding-bottom: 0;
            }
        }

        /* Top Navigation */
        .top-navbar {
            background: var(--primary-gradient);
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 1030;
        }
        .top-navbar .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar-brand {
            color: white;
            font-weight: 700;
            font-size: 18px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .navbar-brand:hover {
            color: white;
        }
        /* 襷アイコン */
        .tasuki-icon {
            width: 22px;
            height: 22px;
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .tasuki-icon::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 4px;
            background: white;
            border-radius: 2px;
            transform: rotate(-45deg);
        }
        .tasuki-icon::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 4px;
            background: rgba(255,255,255,0.6);
            border-radius: 2px;
            transform: rotate(-45deg) translateX(8px);
        }
        .navbar-actions {
            display: flex;
            gap: 8px;
        }
        .navbar-actions .btn {
            color: white;
            background: rgba(255,255,255,0.15);
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
        }
        .navbar-actions .btn:hover {
            background: rgba(255,255,255,0.25);
            color: white;
        }

        /* Desktop Navigation */
        .desktop-nav {
            display: none;
        }
        @media (min-width: 992px) {
            .desktop-nav {
                display: flex;
                gap: 4px;
            }
            .desktop-nav .nav-link {
                color: rgba(255,255,255,0.85);
                padding: 8px 14px;
                border-radius: 6px;
                font-size: 14px;
                text-decoration: none;
                display: flex;
                align-items: center;
                gap: 6px;
                transition: all 0.15s;
            }
            .desktop-nav .nav-link:hover,
            .desktop-nav .nav-link.active {
                color: white;
                background: rgba(255,255,255,0.15);
            }
            .desktop-nav .dropdown-menu {
                border: none;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                border-radius: 10px;
                padding: 8px;
            }
            .desktop-nav .dropdown-item {
                border-radius: 6px;
                padding: 10px 14px;
                font-size: 14px;
            }
            .desktop-nav .dropdown-item:hover {
                background: #f5f7fa;
            }
        }

        /* Mobile Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: calc(8px + var(--safe-area-bottom));
            z-index: 1030;
        }
        @media (min-width: 992px) {
            .bottom-nav {
                display: none;
            }
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #718096;
            font-size: 10px;
            padding: 4px 12px;
            border-radius: 8px;
            transition: all 0.15s;
        }
        .bottom-nav-item i {
            font-size: 20px;
            margin-bottom: 2px;
        }
        .bottom-nav-item:hover,
        .bottom-nav-item.active {
            color: #5a9fd4;
        }
        .bottom-nav-item.active {
            background: rgba(116, 185, 255, 0.15);
        }

        /* Mobile Menu Overlay */
        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1040;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .mobile-menu-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .mobile-menu {
            position: fixed;
            top: 0;
            right: -280px;
            width: 280px;
            height: 100%;
            background: white;
            z-index: 1050;
            transition: right 0.3s;
            overflow-y: auto;
        }
        .mobile-menu.show {
            right: 0;
        }
        .mobile-menu-header {
            background: var(--primary-gradient);
            color: white;
            padding: 20px 16px;
        }
        .mobile-menu-header h5 {
            margin: 0;
            font-size: 18px;
        }
        .mobile-menu-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mobile-menu-list {
            padding: 12px;
        }
        .mobile-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            color: #2d3748;
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 4px;
            transition: background 0.15s;
        }
        .mobile-menu-item:hover {
            background: #f5f7fa;
            color: #2d3748;
        }
        .mobile-menu-item i {
            font-size: 18px;
            width: 24px;
            text-align: center;
            color: #74b9ff;
        }
        .mobile-menu-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 12px 0;
        }

        /* Main Content */
        main.container {
            padding: 1rem 12px;
        }
        @media (min-width: 992px) {
            main.container {
                padding: 1.5rem;
            }
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1060;
            width: calc(100% - 32px);
            max-width: 400px;
            pointer-events: none;
        }
        .toast-item {
            background: #1e293b;
            color: white;
            padding: 14px 16px;
            border-radius: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: toastSlideIn 0.3s ease;
            pointer-events: auto;
        }
        .toast-item.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .toast-item.danger, .toast-item.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        .toast-item.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        .toast-item.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        .toast-item i {
            font-size: 1.2rem;
        }
        .toast-item span {
            flex: 1;
            font-size: 0.9rem;
        }
        .toast-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        /* Pull to Refresh */
        .pull-indicator {
            position: fixed;
            top: 56px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1020;
            transition: transform 0.2s;
            font-size: 0.85rem;
            color: #64748b;
        }
        .pull-indicator.pulling {
            transform: translateX(-50%) translateY(10px);
        }
        .pull-indicator.refreshing {
            transform: translateX(-50%) translateY(10px);
        }
        .pull-indicator .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid #e2e8f0;
            border-top-color: #74b9ff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .pull-indicator .arrow {
            transition: transform 0.2s;
        }
        .pull-indicator.ready .arrow {
            transform: rotate(180deg);
        }

        /* Legacy alert (hidden, using toast instead) */
        .alert {
            display: none;
        }

        /* Card hover effect - disabled on mobile */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            background-color: var(--card-bg);
            transition: background-color 0.3s;
        }
        @media (min-width: 992px) {
            .card-hoverable {
                transition: transform 0.2s, box-shadow 0.2s;
            }
            .card-hoverable:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            }
        }

        /* Dark mode component overrides */
        [data-theme="dark"] .bottom-nav {
            background: var(--nav-bg);
            border-top-color: var(--border-color);
        }
        [data-theme="dark"] .mobile-menu {
            background: var(--menu-bg);
        }
        [data-theme="dark"] .mobile-menu-item {
            color: var(--text-color);
        }
        [data-theme="dark"] .mobile-menu-item:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-color);
        }
        [data-theme="dark"] .mobile-menu-item i {
            color: #a29bfe;
        }
        [data-theme="dark"] .mobile-menu-divider {
            background: var(--border-color);
        }
        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-select {
            background-color: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        [data-theme="dark"] .form-control:focus,
        [data-theme="dark"] .form-select:focus {
            background-color: var(--input-bg);
            border-color: #74b9ff;
            color: var(--text-color);
        }
        [data-theme="dark"] .input-group-text {
            background-color: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-muted);
        }
        [data-theme="dark"] .dropdown-menu {
            background: var(--dropdown-bg);
            border-color: var(--border-color);
        }
        [data-theme="dark"] .dropdown-item {
            color: var(--text-color);
        }
        [data-theme="dark"] .dropdown-item:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-color);
        }
        [data-theme="dark"] .pull-indicator {
            background: var(--card-bg);
            color: var(--text-muted);
        }
        [data-theme="dark"] .text-muted {
            color: var(--text-muted) !important;
        }
        [data-theme="dark"] .btn-outline-secondary {
            color: var(--text-muted);
            border-color: var(--border-color);
        }
        [data-theme="dark"] .btn-light {
            background: var(--card-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        /* Theme toggle button */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px;
            cursor: pointer;
            border-radius: 10px;
            transition: background 0.15s;
        }
        .theme-toggle:hover {
            background: rgba(255,255,255,0.05);
        }
        .theme-toggle i {
            font-size: 18px;
            width: 24px;
            text-align: center;
            color: #74b9ff;
        }
        [data-theme="dark"] .theme-toggle i {
            color: #fbbf24;
        }
        .theme-toggle-switch {
            width: 44px;
            height: 24px;
            background: #e2e8f0;
            border-radius: 12px;
            position: relative;
            margin-left: auto;
            transition: background 0.3s;
        }
        .theme-toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        [data-theme="dark"] .theme-toggle-switch {
            background: #74b9ff;
        }
        [data-theme="dark"] .theme-toggle-switch::after {
            transform: translateX(20px);
        }

        /* Footer - hidden on mobile */
        footer {
            display: none;
        }
        @media (min-width: 992px) {
            footer {
                display: block;
                background: #f8f9fa;
                padding: 1.5rem 0;
                margin-top: auto;
            }
        }

        /* Page Loading Overlay */
        .page-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .page-loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        [data-theme="dark"] .page-loading-overlay {
            background: rgba(15, 23, 42, 0.9);
        }
        .page-loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: #74b9ff;
            border-radius: 50%;
            animation: pageLoadSpin 0.8s linear infinite;
        }
        [data-theme="dark"] .page-loading-spinner {
            border-color: #334155;
            border-top-color: #a29bfe;
        }
        .page-loading-text {
            margin-top: 12px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        @keyframes pageLoadSpin {
            to { transform: rotate(360deg); }
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Page Loading Overlay -->
    <div class="page-loading-overlay" id="pageLoadingOverlay">
        <div class="page-loading-spinner"></div>
        <div class="page-loading-text">読み込み中...</div>
    </div>

    <!-- Top Navigation -->
    <nav class="top-navbar">
        <div class="container">
            <a class="navbar-brand" href="/">
                <span class="tasuki-icon"></span> 南陽・東置賜駅伝
            </a>

            <!-- Desktop Navigation -->
            <div class="desktop-nav">
                <a class="nav-link" href="/"><i class="bi bi-people-fill"></i> 選手</a>
                <a class="nav-link" href="/races"><i class="bi bi-trophy"></i> レース</a>
                <a class="nav-link" href="/team_records"><i class="bi bi-flag-fill"></i> 駅伝記録</a>
                <a class="nav-link" href="/record/add"><i class="bi bi-stopwatch"></i> 記録登録</a>
                <a class="nav-link" href="/analysis"><i class="bi bi-graph-up"></i> 分析</a>
                <div class="dropdown">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                        <i class="bi bi-gear"></i> 設定
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/masters"><i class="bi bi-list-ul me-2"></i>マスタ管理</a></li>
                        <li><a class="dropdown-item" href="/statistics"><i class="bi bi-bar-chart-line me-2"></i>統計</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/export/players"><i class="bi bi-download me-2"></i>選手CSV</a></li>
                        <li><a class="dropdown-item" href="/export/records"><i class="bi bi-download me-2"></i>記録CSV</a></li>
                    </ul>
                </div>
            </div>

            <!-- Mobile Menu Button -->
            <div class="navbar-actions d-lg-none">
                <button class="btn" onclick="toggleMobileMenu()">
                    <i class="bi bi-list" style="font-size: 20px;"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="toggleMobileMenu()"></div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <h5><span class="tasuki-icon" style="vertical-align: middle;"></span> 南陽・東置賜駅伝</h5>
            <button class="mobile-menu-close" onclick="toggleMobileMenu()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="mobile-menu-list">
            <a href="/" class="mobile-menu-item"><i class="bi bi-people-fill"></i> 選手一覧</a>
            <a href="/player/add" class="mobile-menu-item"><i class="bi bi-person-plus"></i> 選手追加</a>
            <div class="mobile-menu-divider"></div>
            <a href="/races" class="mobile-menu-item"><i class="bi bi-trophy"></i> レース一覧</a>
            <a href="/race/add" class="mobile-menu-item"><i class="bi bi-plus-circle"></i> レース追加</a>
            <div class="mobile-menu-divider"></div>
            <a href="/team_records" class="mobile-menu-item"><i class="bi bi-flag-fill"></i> 駅伝記録</a>
            <a href="/record/add" class="mobile-menu-item"><i class="bi bi-stopwatch"></i> 記録登録</a>
            <div class="mobile-menu-divider"></div>
            <a href="/calendar" class="mobile-menu-item"><i class="bi bi-calendar3"></i> カレンダー</a>
            <a href="/analysis" class="mobile-menu-item"><i class="bi bi-graph-up"></i> 分析</a>
            <a href="/practice_logs" class="mobile-menu-item"><i class="bi bi-journal-text"></i> 練習日誌</a>
            <a href="/attendance" class="mobile-menu-item"><i class="bi bi-person-check"></i> 出欠管理</a>
            <a href="/statistics" class="mobile-menu-item"><i class="bi bi-bar-chart-line"></i> 統計</a>
            <div class="mobile-menu-divider"></div>
            <a href="/masters" class="mobile-menu-item"><i class="bi bi-list-ul"></i> マスタ管理</a>
            <a href="/export/players" class="mobile-menu-item"><i class="bi bi-download"></i> 選手CSV出力</a>
            <a href="/export/records" class="mobile-menu-item"><i class="bi bi-download"></i> 記録CSV出力</a>
            <div class="mobile-menu-divider"></div>
            <div class="theme-toggle" onclick="toggleTheme()">
                <i class="bi bi-moon-fill" id="themeIcon"></i>
                <span id="themeLabel">ダークモード</span>
                <div class="theme-toggle-switch"></div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Pull to Refresh Indicator -->
    <div class="pull-indicator" id="pullIndicator">
        <i class="bi bi-arrow-down arrow"></i>
        <span class="pull-text">下に引いて更新</span>
        <div class="spinner" style="display: none;"></div>
    </div>

    <!-- Main Content -->
    <main class="container" id="mainContent">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        {% for category, message in messages %}
                        showToast('{{ message|e }}', '{{ category }}');
                        {% endfor %}
                    });
                </script>
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <!-- Mobile Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="/" class="bottom-nav-item">
            <i class="bi bi-people-fill"></i>
            <span>選手</span>
        </a>
        <a href="/races" class="bottom-nav-item">
            <i class="bi bi-trophy"></i>
            <span>レース</span>
        </a>
        <a href="/team_records" class="bottom-nav-item">
            <i class="bi bi-flag-fill"></i>
            <span>駅伝</span>
        </a>
        <a href="/calendar" class="bottom-nav-item">
            <i class="bi bi-calendar3"></i>
            <span>予定</span>
        </a>
        <a href="/analysis" class="bottom-nav-item">
            <i class="bi bi-graph-up"></i>
            <span>分析</span>
        </a>
    </nav>

    <!-- Footer (Desktop only) -->
    <footer>
        <div class="container text-center text-muted">
            <small>&copy; 2024 駅伝チーム管理システム</small>
        </div>
    </footer>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleMobileMenu() {
            document.getElementById('mobileMenu').classList.toggle('show');
            document.getElementById('mobileMenuOverlay').classList.toggle('show');
            document.body.style.overflow = document.getElementById('mobileMenu').classList.contains('show') ? 'hidden' : '';
        }

        // Highlight current page in bottom nav
        document.addEventListener('DOMContentLoaded', function() {
            const path = window.location.pathname;
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                const href = item.getAttribute('href');
                if (path === href || (href !== '/' && path.startsWith(href))) {
                    item.classList.add('active');
                }
            });
        });

        // Dark Mode Toggle
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            setTheme(theme);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            updateThemeUI(theme);
            // Update meta theme-color for mobile browsers
            const metaTheme = document.querySelector('meta[name="theme-color"]');
            if (metaTheme) {
                metaTheme.setAttribute('content', theme === 'dark' ? '#1e293b' : '#74b9ff');
            }
        }

        function updateThemeUI(theme) {
            const icon = document.getElementById('themeIcon');
            const label = document.getElementById('themeLabel');
            if (icon && label) {
                if (theme === 'dark') {
                    icon.className = 'bi bi-sun-fill';
                    label.textContent = 'ライトモード';
                } else {
                    icon.className = 'bi bi-moon-fill';
                    label.textContent = 'ダークモード';
                }
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }

        // Initialize theme on page load
        initTheme();

        // Page Loading Overlay
        (function() {
            const overlay = document.getElementById('pageLoadingOverlay');
            if (!overlay) return;

            // Show loading on page navigation
            document.addEventListener('click', function(e) {
                const link = e.target.closest('a');
                if (link && link.href && !link.href.startsWith('javascript:') &&
                    !link.href.startsWith('#') && !link.target &&
                    !link.hasAttribute('download') &&
                    link.hostname === window.location.hostname) {
                    // Don't show for same page links
                    if (link.pathname === window.location.pathname && link.search === window.location.search) {
                        return;
                    }
                    overlay.classList.add('show');
                }
            });

            // Show loading on form submit
            document.addEventListener('submit', function(e) {
                const form = e.target;
                if (form.tagName === 'FORM' && !form.hasAttribute('data-no-loading')) {
                    overlay.classList.add('show');
                }
            });

            // Hide loading when page is fully loaded (for back/forward navigation)
            window.addEventListener('pageshow', function(e) {
                overlay.classList.remove('show');
            });

            // Hide on initial load
            window.addEventListener('load', function() {
                overlay.classList.remove('show');
            });
        })();

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });
        }

        // Toast Notification System
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast-item ${type}`;

            const icons = {
                success: 'bi-check-circle-fill',
                danger: 'bi-exclamation-circle-fill',
                error: 'bi-exclamation-circle-fill',
                warning: 'bi-exclamation-triangle-fill',
                info: 'bi-info-circle-fill'
            };

            toast.innerHTML = `
                <i class="bi ${icons[type] || icons.info}"></i>
                <span>${message}</span>
                <button class="toast-close" onclick="closeToast(this)">
                    <i class="bi bi-x"></i>
                </button>
            `;

            container.appendChild(toast);

            // Auto dismiss
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'toastSlideOut 0.3s ease forwards';
                    setTimeout(() => toast.remove(), 300);
                }
            }, duration);
        }

        function closeToast(btn) {
            const toast = btn.closest('.toast-item');
            toast.style.animation = 'toastSlideOut 0.3s ease forwards';
            setTimeout(() => toast.remove(), 300);
        }

        // Pull to Refresh
        (function() {
            let startY = 0;
            let pulling = false;
            const threshold = 80;
            const indicator = document.getElementById('pullIndicator');
            const mainContent = document.getElementById('mainContent');

            if (!indicator || !mainContent) return;

            // Only enable on mobile
            if (window.innerWidth >= 992) return;

            mainContent.addEventListener('touchstart', function(e) {
                if (window.scrollY === 0) {
                    startY = e.touches[0].clientY;
                    pulling = true;
                }
            }, { passive: true });

            mainContent.addEventListener('touchmove', function(e) {
                if (!pulling) return;

                const currentY = e.touches[0].clientY;
                const diff = currentY - startY;

                if (diff > 0 && window.scrollY === 0) {
                    const pullDistance = Math.min(diff, threshold * 1.5);
                    indicator.classList.add('pulling');
                    indicator.querySelector('.pull-text').textContent =
                        diff > threshold ? '離して更新' : '下に引いて更新';

                    if (diff > threshold) {
                        indicator.classList.add('ready');
                    } else {
                        indicator.classList.remove('ready');
                    }
                }
            }, { passive: true });

            mainContent.addEventListener('touchend', function(e) {
                if (!pulling) return;

                const endY = e.changedTouches[0].clientY;
                const diff = endY - startY;

                if (diff > threshold && window.scrollY === 0) {
                    // Trigger refresh
                    indicator.classList.remove('pulling', 'ready');
                    indicator.classList.add('refreshing');
                    indicator.querySelector('.arrow').style.display = 'none';
                    indicator.querySelector('.spinner').style.display = 'block';
                    indicator.querySelector('.pull-text').textContent = '更新中...';

                    setTimeout(() => {
                        location.reload();
                    }, 500);
                } else {
                    indicator.classList.remove('pulling', 'ready');
                }

                pulling = false;
                startY = 0;
            }, { passive: true });
        })();
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
